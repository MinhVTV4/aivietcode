<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prototype Động - Sửa code bất kỳ với AI (v27.0 - Creative Assistant)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-left-color: #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none; }
        .file-explorer-item { display: flex; align-items: center; padding: 4px 8px; cursor: pointer; border-radius: 4px; user-select: none; }
        .file-explorer-item:hover { background-color: #eef2ff; }
        .file-explorer-item.active { background-color: #c7d2fe; }
        .file-explorer-item svg { width: 16px; height: 16px; margin-right: 8px; flex-shrink: 0; }
        .folder-arrow { transition: transform 0.1s linear; }
        .folder-arrow.open { transform: rotate(90deg); }
        #contextMenu { position: absolute; z-index: 1000; background-color: white; border: 1px solid #e5e7eb; border-radius: 0.375rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 0.5rem 0; min-width: 150px; }
        .context-menu-item { display: block; width: 100%; padding: 0.5rem 1rem; font-size: 0.875rem; text-align: left; }
        .context-menu-item:hover { background-color: #f3f4f6; }
        
        /* Fullscreen loader styles */
        .loader-spin {
            border: 5px solid #f3f3f3; /* Light grey */
            border-top: 5px solid #4f46e5; /* Indigo */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        /* Chat bubble styles */
        .chat-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            word-wrap: break-word;
        }
        .chat-bubble-user {
            background-color: #4338ca; /* Indigo-700 */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        .chat-bubble-ai {
            background-color: #e5e7eb; /* Gray-200 */
            color: #1f2937; /* Gray-800 */
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Auth Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Đăng nhập / Đăng ký</h2>
            <div id="auth-error" class="text-red-500 text-sm mb-4 text-center h-4"></div>
            <div class="space-y-4">
                <input id="email-input" type="email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input id="password-input" type="password" placeholder="Mật khẩu" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <div class="flex gap-4">
                    <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Đăng nhập</button>
                    <button id="register-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Đăng ký</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application (hidden by default) -->
    <div id="main-app" class="hidden p-4 md:p-8">
        <div class="max-w-screen-2xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-xl">
            <header class="mb-6 pb-4 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Prototype Động: <span id="project-name-display">Dự án Mới</span></h1>
                    <p id="user-email" class="text-sm text-gray-500 mt-1"></p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button id="new-project-btn" class="bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-bold py-2 px-4 rounded-lg">Dự án Mới (AI)</button>
                    <button id="save-project-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Lưu dự án</button>
                    <button id="load-project-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Mở dự án</button>
                    <button id="export-code-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Xuất file HTML</button>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Đăng xuất</button>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Cột 1: Trình soạn thảo -->
                <div class="flex flex-col">
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">1. Dự án</h2>
                    <div class="flex flex-grow border border-gray-300 rounded-lg shadow-md min-h-[600px]">
                        <div id="fileExplorer" class="w-1/3 max-w-xs bg-gray-50 p-2 border-r border-gray-300 overflow-y-auto"></div>
                        <div id="editorContainer" class="flex-grow"></div>
                    </div>
                </div>

                <!-- Cột 2: AI và các chức năng khác -->
                <div class="flex flex-col">
                    <div class="bg-indigo-50 p-6 rounded-lg border border-indigo-200 h-full">
                         <div class="flex justify-between items-center">
                            <h2 class="text-xl font-semibold text-gray-700">2. Điều khiển AI (Sửa lỗi)</h2>
                            <button id="openIdeaModalBtn" title="Khởi tạo Dự án từ Ý tưởng" class="bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-bold p-2 rounded-full shadow-md transition duration-300 hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a1 1 0 011 1v1.01a5.002 5.002 0 014.37 4.373H16a1 1 0 110 2h-1.01a5.002 5.002 0 01-4.37 4.373V17a1 1 0 11-2 0v-1.01a5.002 5.002 0 01-4.37-4.373H4a1 1 0 110-2h1.01A5.002 5.002 0 019.38 3.01V2a1 1 0 011-1zM4 10a6 6 0 1112 0 6 6 0 01-12 0z" /></svg>
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 mb-4">Nhập yêu cầu để sửa đổi dự án hiện tại.</p>
                        <textarea id="aiPromptInput" class="w-full p-2 border rounded-md" rows="5"></textarea>
                        
                        <div class="mt-2 flex items-center">
                            <input id="focus-mode-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="focus-mode-checkbox" class="ml-2 block text-sm text-gray-900">Chỉ làm việc trên vùng đã chọn</label>
                        </div>

                        <button id="runAiBtn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg flex items-center justify-center">
                            <span id="buttonText">Gửi yêu cầu AI</span>
                            <div id="buttonSpinner" class="spinner hidden ml-3"></div>
                        </button>
                        <h2 class="text-xl font-semibold text-gray-700 mt-8 mb-2">3. Đề xuất của AI</h2>
                        <div id="aiResponseContainer" class="h-96 overflow-y-auto">
                            <p id="aiResponsePlaceholder" class="text-gray-500">Đề xuất của AI sẽ xuất hiện ở đây...</p>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-700 mt-8 mb-2">4. Trạng thái</h2>
                        <div id="status" class="w-full bg-white p-4 rounded-md shadow-inner border text-gray-600 min-h-[50px]"></div>
                    </div>
                </div>
                 <!-- Cột 3: Xem trước (Preview) -->
                <div class="flex flex-col lg:col-span-2 mt-8"> 
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">5. Xem trước trực quan</h2>
                    <button id="openModalBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">Xem trước</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Context Menu -->
    <div id="contextMenu" class="hidden"></div>

    <!-- Preview Modal -->
    <div id="previewModal" class="hidden fixed inset-0 z-50 overflow-y-auto overflow-x-hidden flex items-center justify-center bg-gray-900 bg-opacity-75">
        <div class="relative w-full h-[90vh] max-w-7xl mx-auto p-4 flex flex-col">
            <div class="relative bg-white rounded-lg shadow-xl flex flex-col flex-grow">
                <button type="button" id="closeModalBtn" class="absolute top-3 right-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
                <div class="p-6 flex flex-col flex-grow">
                    <div id="previewControls" class="flex justify-center mb-4 space-x-4">
                        <button id="desktopViewBtn" class="px-5 py-2 rounded-lg shadow-md">Desktop</button>
                        <button id="mobileViewBtn" class="px-5 py-2 rounded-lg shadow-md">Mobile</button>
                    </div>
                    <div id="previewFrameContainer" class="flex-grow flex justify-center items-center overflow-auto bg-gray-50 rounded-lg p-4">
                        <iframe id="previewFrame" title="Visual Preview" class="border border-gray-300 rounded-lg shadow-md"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Project Chat Modal -->
    <div id="newProjectChatModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl flex flex-col h-[90vh]">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-semibold text-gray-800">Trợ lý Sáng tạo Dự án</h3>
                <button id="closeNewProjectModalBtn" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="newProjectChatHistory" class="p-6 flex-grow overflow-y-auto flex flex-col gap-4">
                <!-- Chat messages will be appended here -->
            </div>
            <div class="p-4 border-t bg-gray-50">
                <textarea id="newProjectChatInput" rows="2" class="w-full p-2 border rounded-md" placeholder="Mô tả ý tưởng của bạn..."></textarea>
                <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button id="newProjectDiscussBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                        <span id="newProjectDiscussBtnText">Thảo luận</span>
                        <div id="newProjectDiscussSpinner" class="spinner hidden ml-3"></div>
                    </button>
                    <button id="newProjectGenerateBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                        <span id="newProjectGenerateBtnText">Tạo Dự án từ cuộc trò chuyện</span>
                        <div id="newProjectGenerateSpinner" class="spinner hidden ml-3"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Project Modal -->
    <div id="loadProjectModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="load-modal-title" class="text-xl font-semibold text-gray-800">Mở Dự án</h3>
                <button id="closeLoadModalBtn" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="load-modal-content" class="p-6 max-h-96 overflow-y-auto"></div>
        </div>
    </div>
    
    <!-- Generic Modal -->
    <div id="genericModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-75 transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg flex flex-col transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="modalTitle" class="text-xl font-semibold text-gray-800"></h3>
                <button id="modalCloseBtn" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="modalContent" class="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                <!-- Content will be injected here by JS -->
            </div>
            <div id="modalActions" class="flex justify-end p-4 bg-gray-50 border-t rounded-b-lg space-x-3">
                <!-- Action buttons will be injected here by JS -->
            </div>
        </div>
    </div>

    <!-- Full Screen Loader -->
    <div id="fullScreenLoader" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-white bg-opacity-80">
        <div class="flex flex-col items-center">
            <div class="loader-spin"></div>
            <p id="loaderText" class="mt-4 text-lg font-semibold text-gray-700">Đang xử lý...</p>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-ai.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, query, where, orderBy, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDt6KZTLJ5ItNShxAPlpKKHC8eHiIBSjmY",
            authDomain: "aicodepro-lien.firebaseapp.com",
            projectId: "aicodepro-lien",
            storageBucket: "aicodepro-lien.firebasestorage.app",
            messagingSenderId: "277847908656",
            appId: "1:277847908656:web:77eb210b8e2b2b7dbca8f5"
        };

        // --- App State ---
        let monacoEditor, aiModel, auth, db;
        let activeFilePath = 'index.html';
        let projectStructure = {};
        let projectModels = {};
        let currentUser = null;
        let isEditorInitialized = false;
        let undoStacks = {};
        let currentProjectId = null;
        let currentProjectName = null;
        let activeDiffEditors = [];
        let newProjectChatHistory = []; // For the new project chat modal

        // --- DOM Elements ---
        const authScreen = document.getElementById('auth-screen');
        const mainApp = document.getElementById('main-app');
        const fileExplorer = document.getElementById('fileExplorer');
        const editorContainer = document.getElementById('editorContainer');
        const contextMenu = document.getElementById('contextMenu');
        const statusEl = document.getElementById('status');
        const runAiBtn = document.getElementById('runAiBtn');
        const openModalBtn = document.getElementById('openModalBtn');
        const aiResponseContainer = document.getElementById('aiResponseContainer');
        const aiResponsePlaceholder = document.getElementById('aiResponsePlaceholder');
        const previewModal = document.getElementById('previewModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const desktopViewBtn = document.getElementById('desktopViewBtn');
        const mobileViewBtn = document.getElementById('mobileViewBtn');
        const focusModeCheckbox = document.getElementById('focus-mode-checkbox');
        const newProjectChatModal = document.getElementById('newProjectChatModal');

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        
        // --- Auth Logic ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                authScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                document.getElementById('user-email').textContent = `Chào, ${user.email}`;
                if (!isEditorInitialized) {
                    initializeEditorAndAI();
                }
            } else {
                currentUser = null;
                authScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
        });
        
        // --- Editor & App Initialization ---
        function initializeEditorAndAI() {
            statusEl.textContent = "Đang khởi tạo trình soạn thảo...";
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
            require(['vs/editor/editor.main'], () => {
                loadInitialProject();
                monacoEditor = monaco.editor.create(editorContainer, {
                    model: projectModels[activeFilePath],
                    theme: 'vs-light',
                    automaticLayout: true
                });
                renderFileExplorer();
                updatePreview();
                attachAppEventListeners();
                
                try {
                    aiModel = getGenerativeModel(getAI(app), { model: "gemini-2.5-flash" });
                    statusEl.textContent = "Hệ thống đã sẵn sàng.";
                } catch (e) {
                    statusEl.textContent = `Lỗi khởi tạo AI: ${e.message}`;
                }
                isEditorInitialized = true;
            });
        }

        function loadInitialProject() {
            Object.values(projectModels).forEach(model => model.dispose());
            projectModels = {};
            currentProjectId = null;
            currentProjectName = "Dự án Mới";
            updateProjectDisplay();

            const sampleFiles = {
                'index.html': `<!DOCTYPE html>\n<html lang="en">\n<head>\n    <title>Dự án Mới</title>\n    <link rel="stylesheet" href="src/css/style.css">\n</head>\n<body>\n    <h1>Chào mừng!</h1>\n    <script src="src/js/script.js"><\/script>\n</body>\n</html>`,
                'src/css/style.css': `body {\n    font-family: sans-serif;\n}`,
                'src/js/script.js': `console.log("Hello World!");`
            };
            loadProjectFromData(sampleFiles);
        }

        function loadProjectFromData(filesData) {
            // Dispose old models if they exist
            if (projectModels) {
                Object.values(projectModels).forEach(model => model.dispose());
            }
            projectModels = {};
            currentProjectId = null;
            currentProjectName = "Dự án Mới";
            updateProjectDisplay();

            projectStructure = {
                'index.html': { type: 'file' },
                'src': { type: 'folder', isOpen: true, children: {
                    'css': { type: 'folder', isOpen: true, children: { 'style.css': { type: 'file' } } },
                    'js': { type: 'folder', isOpen: true, children: { 'script.js': { type: 'file' } } }
                }}
            };
            
            createModelsFromStructure(projectStructure, filesData);
            activeFilePath = 'index.html';
            if(monacoEditor) {
                monacoEditor.setModel(projectModels[activeFilePath]);
                renderFileExplorer();
                updatePreview();
            }
        }

        // --- Firestore Logic ---
        async function saveProject() {
            const files = {};
            Object.entries(projectModels).forEach(([path, model]) => {
                files[path] = model.getValue();
            });

            if (currentProjectId) {
                const commitMessage = await showPrompt("Lưu phiên bản mới", "Nhập ghi chú cho phiên bản này (ví dụ: 'Thêm nút đăng nhập'):", "");
                if (commitMessage === null) return;

                showLoader("Đang lưu phiên bản...");
                try {
                    const projectRef = doc(db, "projects", currentProjectId);
                    const projectSnap = await getDoc(projectRef);
                    const currentVersion = projectSnap.data().latestVersion || 0;
                    const newVersionNumber = currentVersion + 1;

                    const versionRef = collection(db, "projects", currentProjectId, "versions");
                    await addDoc(versionRef, {
                        versionNumber: newVersionNumber,
                        commitMessage: commitMessage,
                        structure: JSON.stringify(projectStructure),
                        files: files,
                        createdAt: serverTimestamp()
                    });

                    await updateDoc(projectRef, {
                        latestVersion: newVersionNumber,
                        lastUpdatedAt: serverTimestamp()
                    });
                    
                    statusEl.textContent = `Đã lưu phiên bản ${newVersionNumber} cho dự án "${currentProjectName}".`;
                } catch (error) {
                    console.error("Lỗi khi lưu phiên bản mới:", error);
                    statusEl.textContent = "Lỗi khi lưu phiên bản mới.";
                } finally {
                    hideLoader();
                }

            } else {
                const projectName = await showPrompt("Tạo dự án mới", "Nhập tên dự án:", "Dự án của tôi");
                if (!projectName) return;

                showLoader("Đang tạo dự án...");
                try {
                    const projectRef = await addDoc(collection(db, "projects"), {
                        uid: currentUser.uid,
                        name: projectName,
                        createdAt: serverTimestamp(),
                        lastUpdatedAt: serverTimestamp(),
                        latestVersion: 1
                    });

                    const versionRef = collection(db, "projects", projectRef.id, "versions");
                    await addDoc(versionRef, {
                        versionNumber: 1,
                        commitMessage: "Phiên bản đầu tiên",
                        structure: JSON.stringify(projectStructure),
                        files: files,
                        createdAt: serverTimestamp()
                    });

                    currentProjectId = projectRef.id;
                    currentProjectName = projectName;
                    updateProjectDisplay();
                    statusEl.textContent = `Đã tạo và lưu dự án "${projectName}" thành công.`;
                } catch (error) {
                    console.error("Lỗi khi tạo dự án mới:", error);
                    statusEl.textContent = "Lỗi khi tạo dự án mới.";
                } finally {
                    hideLoader();
                }
            }
        }

        async function loadProjects() {
            const modalContent = document.getElementById('load-modal-content');
            modalContent.innerHTML = '<div class="flex justify-center"><div class="loader-spin"></div></div>';
            document.getElementById('load-modal-title').textContent = "Mở Dự án";
            document.getElementById('loadProjectModal').classList.remove('hidden');

            const q = query(collection(db, "projects"), where("uid", "==", currentUser.uid), orderBy("lastUpdatedAt", "desc"));
            const querySnapshot = await getDocs(q);
            
            modalContent.innerHTML = '';
            if (querySnapshot.empty) {
                modalContent.textContent = "Bạn chưa có dự án nào.";
                return;
            }
            querySnapshot.forEach((doc) => {
                const project = doc.data();
                const div = document.createElement('div');
                div.className = "p-2 hover:bg-gray-100 cursor-pointer rounded";
                div.textContent = project.name;
                div.onclick = () => showProjectVersions(doc.id, project.name);
                modalContent.appendChild(div);
            });
        }

        async function showProjectVersions(projectId, projectName) {
            const modalContent = document.getElementById('load-modal-content');
            modalContent.innerHTML = '<div class="flex justify-center"><div class="loader-spin"></div></div>';
            document.getElementById('load-modal-title').textContent = `Phiên bản của "${projectName}"`;
            
            const backButton = document.createElement('button');
            backButton.className = "mb-4 text-sm text-indigo-600 hover:underline";
            backButton.textContent = "← Quay lại danh sách dự án";
            backButton.onclick = loadProjects;
            
            const versionsList = document.createElement('div');
            
            modalContent.innerHTML = '';
            modalContent.appendChild(backButton);
            modalContent.appendChild(versionsList);
            
            const q = query(collection(db, "projects", projectId, "versions"), orderBy("versionNumber", "desc"));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                versionsList.textContent = "Dự án này chưa có phiên bản nào.";
                return;
            }
            querySnapshot.forEach((doc) => {
                const version = doc.data();
                const div = document.createElement('div');
                div.className = "p-2 hover:bg-gray-100 cursor-pointer rounded border-b";
                div.innerHTML = `
                    <p class="font-semibold">Phiên bản ${version.versionNumber}</p>
                    <p class="text-sm text-gray-600">${version.commitMessage}</p>
                    <p class="text-xs text-gray-400">${version.createdAt ? version.createdAt.toDate().toLocaleString() : 'N/A'}</p>
                `;
                div.onclick = () => openProjectVersion(projectId, projectName, doc.id);
                versionsList.appendChild(div);
            });
        }

        async function openProjectVersion(projectId, projectName, versionId) {
            document.getElementById('loadProjectModal').classList.add('hidden');
            showLoader("Đang mở dự án...");
            try {
                const docRef = doc(db, "projects", projectId, "versions", versionId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const versionData = docSnap.data();
                    Object.values(projectModels).forEach(model => model.dispose());
                    projectModels = {};

                    projectStructure = JSON.parse(versionData.structure);
                    createModelsFromStructure(projectStructure, versionData.files);
                    
                    currentProjectId = projectId;
                    currentProjectName = projectName;
                    updateProjectDisplay();

                    activeFilePath = 'index.html';
                    monacoEditor.setModel(projectModels[activeFilePath]);
                    renderFileExplorer();
                    updatePreview();
                    statusEl.textContent = `Đã mở dự án "${projectName}", phiên bản ${versionData.versionNumber}.`;
                } else {
                    statusEl.textContent = "Không tìm thấy phiên bản dự án.";
                }
            } catch (error) {
                console.error("Lỗi khi mở dự án:", error);
                statusEl.textContent = `Lỗi khi mở dự án: ${error.message}`;
            } finally {
                hideLoader();
            }
        }
        
        function updateProjectDisplay() {
            document.getElementById('project-name-display').textContent = currentProjectName;
            const saveBtn = document.getElementById('save-project-btn');
            if (currentProjectId) {
                saveBtn.textContent = "Lưu phiên bản mới";
            } else {
                saveBtn.textContent = "Lưu dự án";
            }
        }

        // --- Helper Functions ---
        function createModelsFromStructure(structure, files, pathPrefix = '') {
            Object.entries(structure).forEach(([name, item]) => {
                const currentPath = pathPrefix ? `${pathPrefix}/${name}` : name;
                if (item.type === 'file') {
                    const model = monaco.editor.createModel(
                        files[currentPath] || "",
                        getLanguageForFile(currentPath)
                    );
                    model.onDidChangeContent(updatePreview);
                    projectModels[currentPath] = model;
                } else if (item.children) {
                    createModelsFromStructure(item.children, files, currentPath);
                }
            });
        }
        
        // --- Core Logic & File Management ---
        function getLanguageForFile(filename) {
            const extension = filename.split('.').pop();
            switch (extension) {
                case 'js': return 'javascript';
                case 'css': return 'css';
                case 'html': return 'html';
                default: return 'plaintext';
            }
        }

        function findItemAndParentByPath(path) {
            if (!path) return { item: null, parent: null, key: null };
            const parts = path.split('/');
            let currentLevel = projectStructure;
            let parent = { children: projectStructure };
            let currentItem = null;

            for (let i = 0; i < parts.length; i++) {
                const key = parts[i];
                if (!currentLevel || !currentLevel[key]) return { item: null, parent: null, key: null };
                
                if (i === parts.length - 1) {
                    currentItem = currentLevel[key];
                    parent = (i === 0) ? null : findItemByPath(parts.slice(0, i).join('/'))?.item;
                    return { item: currentItem, parent: parent?.children || projectStructure, key: key };
                }
                currentLevel = currentLevel[key].children;
            }
            return { item: null, parent: null, key: null };
        }

        function findItemByPath(path) {
            if (!path) return { item: projectStructure };
            const parts = path.split('/');
            let currentItem = projectStructure;
            for (const part of parts) {
                if (!currentItem) return { item: null };
                currentItem = currentItem.children ? currentItem.children[part] : currentItem[part];
            }
            return { item: currentItem };
        }
        
        function renderFileExplorer() {
            fileExplorer.innerHTML = '';
            const rootUl = document.createElement('ul');
            
            function createTree(structure, parentElement, pathPrefix = '') {
                Object.entries(structure).forEach(([name, item]) => {
                    const currentPath = pathPrefix ? `${pathPrefix}/${name}` : name;
                    const li = document.createElement('li');
                    li.dataset.path = currentPath;
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'file-explorer-item';
                    itemDiv.dataset.path = currentPath;
                    if (currentPath === activeFilePath) itemDiv.classList.add('active');
                    
                    if (item.type === 'folder') {
                        itemDiv.innerHTML = `<svg class="folder-arrow ${item.isOpen ? 'open' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg><svg fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path></svg><span>${name}</span>`;
                        itemDiv.addEventListener('click', (e) => { e.stopPropagation(); toggleFolder(item); });
                        li.appendChild(itemDiv);
                        if (item.isOpen && item.children) {
                            const childrenUl = document.createElement('ul');
                            childrenUl.style.paddingLeft = '16px';
                            createTree(item.children, childrenUl, currentPath);
                            li.appendChild(childrenUl);
                        }
                    } else {
                        itemDiv.innerHTML = `<svg style="margin-left: 16px;" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h2a2 2 0 002-2V4a2 2 0 00-2-2H9z"></path><path d="M4 12a2 2 0 012-2h1v4a2 2 0 002 2h1v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-4z"></path></svg><span>${name}</span>`;
                        itemDiv.addEventListener('click', (e) => { e.stopPropagation(); switchFile(currentPath); });
                        li.appendChild(itemDiv);
                    }
                    parentElement.appendChild(li);
                });
            }
            createTree(projectStructure, rootUl);
            fileExplorer.appendChild(rootUl);
        }

        function showContextMenu(e) {
            e.preventDefault();
            const target = e.target.closest('[data-path], #fileExplorer');
            const path = target.dataset.path || '';

            let menuItems = '';
            const { item } = findItemAndParentByPath(path);
            const targetType = item ? item.type : 'root';

            if (targetType === 'file') {
                menuItems = `<button class="context-menu-item" onclick="window.handleRename('${path}')">Đổi tên</button>
                             <button class="context-menu-item" onclick="window.handleDelete('${path}')">Xóa</button>`;
            } else { // Folder or root
                menuItems = `<button class="context-menu-item" onclick="window.handleNewFile('${path}')">Tệp mới</button>
                             <button class="context-menu-item" onclick="window.handleNewFolder('${path}')">Thư mục mới</button>`;
                if (targetType === 'folder') {
                    menuItems += `<div class="my-1 h-px bg-gray-200"></div>
                                  <button class="context-menu-item" onclick="window.handleRename('${path}')">Đổi tên</button>
                                  <button class="context-menu-item" onclick="window.handleDelete('${path}')">Xóa</button>`;
                }
            }
            
            contextMenu.innerHTML = menuItems;
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.top = `${e.pageY}px`;
            contextMenu.classList.remove('hidden');
        }

        function hideContextMenu() {
            contextMenu.classList.add('hidden');
        }

        // --- File Operations ---
        window.handleNewFile = async (parentPath) => {
            hideContextMenu();
            const filename = await showPrompt("Tạo tệp mới", "Nhập tên tệp:", "new-file.js");
            if (!filename) return;

            const newPath = parentPath ? `${parentPath}/${filename}` : filename;
            const { item: parentItem } = findItemByPath(parentPath);
            const targetChildren = parentPath ? parentItem.children : projectStructure;

            if (targetChildren[filename]) {
                showAlert("Lỗi", "Một tệp hoặc thư mục với tên này đã tồn tại.");
                return;
            }
            
            targetChildren[filename] = { type: 'file' };
            projectModels[newPath] = monaco.editor.createModel("", getLanguageForFile(filename));
            projectModels[newPath].onDidChangeContent(updatePreview);
            renderFileExplorer();
            switchFile(newPath);
        };

        window.handleNewFolder = async (parentPath) => {
            hideContextMenu();
            const foldername = await showPrompt("Tạo thư mục mới", "Nhập tên thư mục:", "new-folder");
            if (!foldername) return;

            const { item: parentItem } = findItemByPath(parentPath);
            const targetChildren = parentPath ? parentItem.children : projectStructure;

            if (targetChildren[foldername]) {
                showAlert("Lỗi", "Một tệp hoặc thư mục với tên này đã tồn tại.");
                return;
            }

            targetChildren[foldername] = { type: 'folder', isOpen: true, children: {} };
            renderFileExplorer();
        };

        window.handleRename = async (path) => {
            hideContextMenu();
            const { item, parent, key } = findItemAndParentByPath(path);
            if (!item) return;

            const newName = await showPrompt("Đổi tên", "Nhập tên mới:", key);
            if (!newName || newName === key) return;
            
            if (parent[newName]) {
                showAlert("Lỗi", "Một tệp hoặc thư mục với tên này đã tồn tại.");
                return;
            }

            parent[newName] = item;
            delete parent[key];

            if (item.type === 'file') {
                const newPath = path.substring(0, path.lastIndexOf('/') + 1) + newName;
                projectModels[newPath] = projectModels[path];
                delete projectModels[path];
                if(activeFilePath === path) activeFilePath = newPath;
            } else { 
                function updateChildPaths(oldPathPrefix, newPathPrefix) {
                    Object.keys(projectModels).forEach(p => {
                        if (p.startsWith(oldPathPrefix + '/')) {
                            const newP = newPathPrefix + p.substring(oldPathPrefix.length);
                            projectModels[newP] = projectModels[p];
                            delete projectModels[p];
                            if(activeFilePath === p) activeFilePath = newP;
                        }
                    });
                }
                const newPath = path.substring(0, path.lastIndexOf('/') + 1) + newName;
                updateChildPaths(path, newPath);
            }
            
            renderFileExplorer();
        };

        window.handleDelete = async (path, skipConfirm = false) => {
            hideContextMenu();
            const { item, parent, key } = findItemAndParentByPath(path);
            if (!item) return;
            
            const confirmed = skipConfirm ? true : await showConfirm("Xác nhận xóa", `Bạn có chắc muốn xóa "${key}"? Hành động này không thể hoàn tác.`);
            if (!confirmed) return;

            delete parent[key];

            function deleteRecursive(p) {
                if (projectModels[p]) {
                    projectModels[p].dispose();
                    delete projectModels[p];
                }
                Object.keys(projectModels).forEach(childPath => {
                    if (childPath.startsWith(p + '/')) {
                        projectModels[childPath].dispose();
                        delete projectModels[childPath];
                    }
                });
            }
            deleteRecursive(path);

            if (activeFilePath.startsWith(path)) {
                switchFile('index.html');
            }

            renderFileExplorer();
        };

        function toggleFolder(folderItem) {
            folderItem.isOpen = !folderItem.isOpen;
            renderFileExplorer();
        }

        function switchFile(filePath) {
            if (!projectModels[filePath]) {
                console.error(`Model not found for path: ${filePath}`);
                return;
            }
            activeFilePath = filePath;
            monacoEditor.setModel(projectModels[filePath]);
            renderFileExplorer();
        }

        // --- Preview & Export Logic ---
        function getBuiltHtml() {
            let htmlContent = projectModels['index.html']?.getValue() || '';
            
            const linkRegex = /<link\s+.*?href="([^"]+)"[^>]*>/g;
            const scriptRegex = /<script\s+.*?src="([^"]+)"[^>]*><\/script>/g;

            htmlContent = htmlContent.replace(linkRegex, (match, href) => {
                const cssContent = projectModels[href]?.getValue();
                return cssContent ? `<style>\n${cssContent}\n</style>` : match;
            });

            htmlContent = htmlContent.replace(scriptRegex, (match, src) => {
                if (!src) return match;
                const jsContent = projectModels[src]?.getValue();
                return jsContent ? `<script>${jsContent.replace(/<\/script>/g, '<\\/script>')}<\/script>` : match;
            });
            return htmlContent;
        }

        function updatePreview() {
            try {
                const frame = document.getElementById('previewFrame');
                if (!frame) return;
                frame.srcdoc = getBuiltHtml();
            } catch (e) { 
                console.error("Lỗi khi cập nhật xem trước:", e);
            }
        }
        
        async function exportProjectAsHtml() {
            try {
                const htmlContent = getBuiltHtml();
                const textarea = document.createElement('textarea');
                textarea.value = htmlContent;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                await showAlert('Thành công!', 'Toàn bộ code dự án (dưới dạng một file HTML) đã được sao chép vào clipboard của bạn.');
            } catch (e) { 
                console.error("Lỗi khi xuất code:", e);
                await showAlert('Lỗi', 'Đã có lỗi xảy ra khi sao chép code.');
            }
        }

        function setPreviewMode(mode) {
            const frame = document.getElementById('previewFrame');
            if (mode === 'desktop') {
                frame.style.width = '100%';
                frame.style.height = '100%';
            } else {
                frame.style.width = '375px';
                frame.style.height = '667px';
            }
        }

        // --- AI Interaction Logic (Editing) ---
        async function getAiSuggestion() {
            undoStacks = {};
            const userPrompt = document.getElementById('aiPromptInput').value.trim();
            if (!userPrompt) {
                showAlert("Thiếu thông tin", "Vui lòng nhập yêu cầu cho AI.");
                return;
            }

            setLoadingState(true);
            aiResponseContainer.innerHTML = '';
            aiResponsePlaceholder.textContent = "Đang chờ phản hồi...";
            aiResponseContainer.appendChild(aiResponsePlaceholder);

            try {
                let projectContext = '';
                let finalPrompt = '';
                const isFocusMode = focusModeCheckbox.checked;
                const selection = monacoEditor.getSelection();
                const selectedText = monacoEditor.getModel().getValueInRange(selection);

                if (isFocusMode) {
                    if (!selectedText) {
                        throw new Error("Chế độ Tập trung đang bật. Vui lòng bôi đen một đoạn code.");
                    }
                    projectContext = `The user has selected the following code snippet from the file \`${activeFilePath}\`:\n\`\`\`\n${selectedText}\n\`\`\``;
                    finalPrompt = `You are an expert code modification assistant. Your task is to modify the provided code snippet based on the user's request.
CODE SNIPPET:
${projectContext}
USER'S REQUEST:
"${userPrompt}"
TASK:
Generate a JSON object with a "changes" array containing a single modification object.
- "action" must be "modify".
- "file" must be "${activeFilePath}".
- "reasoning" must be a DETAILED explanation in VIETNAMESE about why the change is necessary and what it improves.
- "oldCode" MUST be an EXACT, character-for-character copy of the original code snippet. DO NOT reformat or change any whitespace or indentation.
- "newCode" MUST be the complete, modified version of the snippet.
**CRITICAL JSON FORMATTING RULES:**
- All values must be valid JSON strings (newlines escaped as \\n, quotes as \\").
Wrap the final JSON in \`\`\`json ... \`\`\`.`;

                } else {
                    Object.entries(projectModels).forEach(([path, model]) => {
                        projectContext += `--- START OF ${path} ---\n${model.getValue()}\n--- END OF ${path} ---\n\n`;
                    });
                    finalPrompt = `You are an expert code modification and creation assistant. Analyze the user's request based on the project files.
PROJECT FILES:
${projectContext}
CURRENT USER'S REQUEST:
"${userPrompt}"
TASK:
Generate a JSON object with a "changes" array. Each object in the array represents an action:
- For MODIFICATIONS: { "action": "modify", "file": "path/to/file.ext", "description": "...", "reasoning": "A detailed explanation in VIETNAMESE...", "oldCode": "...", "newCode": "..." }. The "oldCode" value MUST be an EXACT, character-for-character copy of the original code block. DO NOT reformat or change any whitespace or indentation.
- For NEW FILES: { "action": "create", "file": "path/to/new_file.ext", "description": "...", "reasoning": "A detailed explanation in VIETNAMESE about the purpose of this new file...", "newCode": "..." }
**CRITICAL JSON FORMATTING RULES:**
- All values MUST be valid JSON strings (newlines escaped as \\n, quotes as \\").
Wrap the final JSON in \`\`\`json ... \`\`\`.`;
                }

                const result = await aiModel.generateContent(finalPrompt);
                const jsonString = result.response.text().match(/```json\s*([\s\S]*?)\s*```/)?.[1].trim();
                if (!jsonString) throw new Error("Phản hồi của AI không hợp lệ.");

                const aiResponse = JSON.parse(jsonString);
                if (!aiResponse.changes || !Array.isArray(aiResponse.changes)) throw new Error("Phản hồi JSON không đúng định dạng.");
                
                renderChangeList(aiResponse.changes);

            } catch (error) {
                console.error("Lỗi AI:", error);
                statusEl.textContent = `Lỗi: ${error.message}`;
                showAlert("Lỗi AI", error.message);
            } finally {
                setLoadingState(false);
            }
        }

        function renderChangeList(changes) {
            // Dispose any existing diff editors to prevent memory leaks
            activeDiffEditors.forEach(d => {
                d.editor.dispose();
                d.originalModel.dispose();
                d.modifiedModel.dispose();
            });
            activeDiffEditors = [];

            aiResponseContainer.innerHTML = '';
            if (changes.length === 0) {
                aiResponsePlaceholder.textContent = "AI không tìm thấy thay đổi nào.";
                aiResponseContainer.appendChild(aiResponsePlaceholder);
                return;
            }

            changes.forEach((change, i) => {
                change.uniqueId = `change-${i}`;
                const card = document.createElement('div');
                card.className = 'bg-white p-4 mb-4 rounded-lg shadow-md';
                card.id = change.uniqueId;
                
                if (change.action === 'create') {
                    card.innerHTML = `<p class="font-semibold text-gray-800">${change.description || 'Tạo tệp mới'}</p>
                                      <p class="text-sm text-gray-500 mt-2">Tạo tệp mới: <code class="font-mono bg-gray-200 p-1 rounded">${change.file}</code></p>
                                      <div class="mt-2 w-full h-64 border border-gray-300 rounded-md" id="editor-container-${change.uniqueId}"></div>`;
                } else { // modify
                    card.innerHTML = `<p class="font-semibold text-gray-800">${change.description || 'Sửa đổi code'}</p>
                                      <p class="text-sm text-gray-500 mt-2">Trong tệp: <code class="font-mono bg-gray-200 p-1 rounded">${change.file}</code></p>
                                      <div id="diff-container-${change.uniqueId}" class="mt-2 w-full h-64 border border-gray-300 rounded-md"></div>`;
                }
                
                // --- Action Buttons ---
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'mt-4 flex flex-col sm:flex-row gap-2';

                const applyButton = document.createElement('button');
                applyButton.className = 'apply-button w-full sm:w-auto flex-grow bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg';
                applyButton.textContent = 'Áp dụng';
                applyButton.onclick = () => applySingleChange(change);
                
                const explainButton = document.createElement('button');
                explainButton.className = 'explain-button w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg';
                explainButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>Xem giải thích`;
                explainButton.onclick = () => showAlert('Giải thích của AI', change.reasoning || 'AI không cung cấp giải thích cho thay đổi này.');

                buttonContainer.appendChild(applyButton);
                buttonContainer.appendChild(explainButton);
                
                const applyButtonWrapper = document.createElement('div');
                applyButtonWrapper.className = 'apply-buttons';
                applyButtonWrapper.appendChild(buttonContainer);

                const undoButtonContainer = document.createElement('div');
                undoButtonContainer.className = 'undo-buttons mt-4 hidden';
                undoButtonContainer.innerHTML = `<button class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">[↶] Hoàn tác</button>`;
                undoButtonContainer.querySelector('button').addEventListener('click', () => undoChange(change.uniqueId));

                card.appendChild(applyButtonWrapper);
                card.appendChild(undoButtonContainer);
                aiResponseContainer.appendChild(card);

                // Initialize editor after the card is in the DOM
                if (change.action === 'create') {
                    const editorContainer = document.getElementById(`editor-container-${change.uniqueId}`);
                    const viewOnlyEditor = monaco.editor.create(editorContainer, {
                        value: change.newCode,
                        language: getLanguageForFile(change.file),
                        readOnly: true,
                        automaticLayout: true,
                        theme: 'vs-light'
                    });
                } else { // modify
                    const diffContainer = document.getElementById(`diff-container-${change.uniqueId}`);
                    const originalModel = monaco.editor.createModel(change.oldCode, getLanguageForFile(change.file));
                    const modifiedModel = monaco.editor.createModel(change.newCode, getLanguageForFile(change.file));

                    const diffEditor = monaco.editor.createDiffEditor(diffContainer, {
                        enableSplitViewResizing: true,
                        readOnly: true,
                        automaticLayout: true,
                        theme: 'vs-light'
                    });

                    diffEditor.setModel({
                        original: originalModel,
                        modified: modifiedModel
                    });

                    activeDiffEditors.push({
                        editor: diffEditor,
                        originalModel: originalModel,
                        modifiedModel: modifiedModel
                    });
                }
            });
        }

        async function applySingleChange(change) {
            const card = document.getElementById(change.uniqueId);
            if (change.action === 'create') {
                const parts = change.file.split('/');
                const filename = parts.pop();
                const parentPath = parts.join('/');
                const { item: parentFolder } = findItemByPath(parentPath);
                if (parentFolder && (parentPath === '' || parentFolder.type === 'folder')) {
                    const targetChildren = parentPath ? parentFolder.children : projectStructure;
                    targetChildren[filename] = { type: 'file' };
                    projectModels[change.file] = monaco.editor.createModel(change.newCode, getLanguageForFile(change.file));
                    projectModels[change.file].onDidChangeContent(updatePreview);
                    
                    undoStacks[change.uniqueId] = { action: 'create', path: change.file };

                    renderFileExplorer();
                    switchFile(change.file);
                    statusEl.textContent = `Đã tạo tệp ${change.file}`;
                } else {
                    await showAlert("Lỗi", `Không thể tạo tệp, thư mục cha "${parentPath}" không tồn tại.`);
                    return;
                }
            } else { // modify
                const targetModel = projectModels[change.file];
                if (!targetModel) {
                    await showAlert("Lỗi", `Không tìm thấy tệp ${change.file}`);
                    return;
                }

                const isFocusMode = focusModeCheckbox.checked;
                const selection = monacoEditor.getSelection();
                
                let matchRange;
                if (isFocusMode && !selection.isEmpty() && change.file === activeFilePath) {
                    matchRange = selection;
                } else {
                    const match = targetModel.findMatches(change.oldCode, false, false, true, null, true)[0];
                    if (match) {
                        matchRange = match.range;
                    }
                }

                if (matchRange) {
                    let inverseEdits = [];
                    targetModel.pushEditOperations([], [{ range: matchRange, text: change.newCode }], (inverse) => { inverseEdits = inverse; return null; });
                    
                    undoStacks[change.uniqueId] = { action: 'modify', path: change.file, edits: inverseEdits };

                    statusEl.textContent = `Đã cập nhật tệp ${change.file}`;
                } else {
                    await showAlert("Lỗi", `Không tìm thấy mã cũ trong tệp ${change.file}. Vui lòng thử áp dụng thủ công.`);
                    return;
                }
            }
            card.querySelector('.apply-buttons').classList.add('hidden');
            card.querySelector('.undo-buttons').classList.remove('hidden');
        }
        
        function undoChange(uniqueId) {
            const undoInfo = undoStacks[uniqueId];
            if (!undoInfo) return;
            
            if (undoInfo.action === 'create') {
                window.handleDelete(undoInfo.path, true); // Pass true to skip confirm
                statusEl.textContent = `Đã hoàn tác (xóa) tệp ${undoInfo.path}`;
            } else { // modify
                const targetModel = projectModels[undoInfo.path];
                if (targetModel && undoInfo.edits) {
                    targetModel.pushEditOperations([], undoInfo.edits, () => null);
                    statusEl.textContent = `Đã hoàn tác thay đổi trong ${undoInfo.path}`;
                }
            }
            
            delete undoStacks[uniqueId];
            const card = document.getElementById(uniqueId);
            card.querySelector('.apply-buttons').classList.remove('hidden');
            card.querySelector('.undo-buttons').classList.add('hidden');
        }
        
        function setLoadingState(isLoading) {
            const buttonText = document.getElementById('buttonText');
            const buttonSpinner = document.getElementById('buttonSpinner');
            runAiBtn.disabled = isLoading;
            if (buttonSpinner) buttonSpinner.classList.toggle('hidden', !isLoading);
            if (buttonText) buttonText.textContent = isLoading ? 'Đang xử lý...' : 'Gửi yêu cầu AI';
        }

        // --- New Project Creation Logic ---
        function openNewProjectChatModal() {
            newProjectChatHistory = [];
            const chatHistoryEl = document.getElementById('newProjectChatHistory');
            chatHistoryEl.innerHTML = '';
            addMessageToNewProjectChat('ai', 'Chào bạn! Hãy mô tả ý tưởng về trang web bạn muốn tạo. Tôi sẽ giúp bạn biến nó thành hiện thực.');
            document.getElementById('newProjectChatInput').value = '';
            newProjectChatModal.classList.remove('hidden');
        }

        function addMessageToNewProjectChat(role, text) {
            newProjectChatHistory.push({ role, text });
            const chatHistoryEl = document.getElementById('newProjectChatHistory');
            const messageEl = document.createElement('div');
            messageEl.className = `chat-bubble ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`;
            messageEl.textContent = text;
            chatHistoryEl.appendChild(messageEl);
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        }

        async function handleNewProjectDiscussion() {
            const inputEl = document.getElementById('newProjectChatInput');
            const userMessage = inputEl.value.trim();
            if (!userMessage) return;

            addMessageToNewProjectChat('user', userMessage);
            inputEl.value = '';

            const discussBtn = document.getElementById('newProjectDiscussBtn');
            const spinner = document.getElementById('newProjectDiscussSpinner');
            const btnText = document.getElementById('newProjectDiscussBtnText');

            discussBtn.disabled = true;
            btnText.textContent = 'AI đang nghĩ...';
            spinner.classList.remove('hidden');

            try {
                const prompt = `Bạn là một chuyên gia tư vấn và phát triển web. Người dùng muốn tạo một dự án web mới. Dưới đây là cuộc trò chuyện của chúng ta. Hãy tiếp tục thảo luận, đặt câu hỏi để làm rõ yêu cầu, hoặc đưa ra gợi ý.
                
                Lịch sử trò chuyện:
                ${newProjectChatHistory.map(m => `${m.role}: ${m.text}`).join('\n')}
                
                Hãy trả lời một cách ngắn gọn, thân thiện để tiếp tục cuộc thảo luận.`;

                const result = await aiModel.generateContent(prompt);
                const aiResponse = result.response.text();
                addMessageToNewProjectChat('ai', aiResponse);
            } catch (error) {
                console.error("Lỗi thảo luận dự án mới:", error);
                addMessageToNewProjectChat('ai', 'Xin lỗi, đã có lỗi xảy ra. Vui lòng thử lại.');
            } finally {
                discussBtn.disabled = false;
                btnText.textContent = 'Thảo luận';
                spinner.classList.add('hidden');
            }
        }

        async function handleGenerateProjectFromChat() {
            if (newProjectChatHistory.length < 2) {
                showAlert("Thiếu thông tin", "Vui lòng thảo luận thêm về ý tưởng của bạn trước khi tạo dự án.");
                return;
            }

            const generateBtn = document.getElementById('newProjectGenerateBtn');
            const spinner = document.getElementById('newProjectGenerateSpinner');
            const btnText = document.getElementById('newProjectGenerateBtnText');

            generateBtn.disabled = true;
            btnText.textContent = 'Đang tạo...';
            spinner.classList.remove('hidden');
            showLoader("AI đang tạo dự án của bạn...");

            try {
                const prompt = `Dựa trên toàn bộ cuộc trò chuyện sau, hãy tạo ra code cho một dự án web hoàn chỉnh.
                
                Lịch sử trò chuyện:
                ${newProjectChatHistory.map(m => `${m.role}: ${m.text}`).join('\n')}

                Nhiệm vụ:
                1. Phân tích toàn bộ yêu cầu của người dùng.
                2. Tạo ra nội dung code đầy đủ cho 3 tệp: 'index.html', 'src/css/style.css', và 'src/js/script.js'.
                3. Đảm bảo các tệp được liên kết với nhau đúng cách trong file HTML.
                4. Trả về một đối tượng JSON duy nhất có cấu trúc như sau: { "index.html": "...", "src/css/style.css": "...", "src/js/script.js": "..." }.
                **QUAN TRỌNG:** Chỉ trả về đối tượng JSON, không có bất kỳ văn bản hay giải thích nào khác.`;

                const result = await aiModel.generateContent(prompt);
                const jsonString = result.response.text().match(/```json\s*([\s\S]*?)\s*```/)?.[1].trim();
                
                if (!jsonString) {
                    throw new Error("AI đã không trả về định dạng JSON hợp lệ.");
                }

                const filesData = JSON.parse(jsonString);
                
                if (!filesData['index.html'] || !filesData['src/css/style.css'] || !filesData['src/js/script.js']) {
                    throw new Error("Đối tượng JSON trả về thiếu các tệp cần thiết.");
                }

                loadProjectFromData(filesData);
                newProjectChatModal.classList.add('hidden');
                statusEl.textContent = "Dự án mới đã được tạo thành công bởi AI!";
                showAlert("Thành công!", "Dự án mới của bạn đã được tạo và nạp vào trình soạn thảo.");

            } catch (error) {
                console.error("Lỗi tạo dự án từ AI:", error);
                showAlert("Lỗi", `Đã xảy ra lỗi khi tạo dự án: ${error.message}`);
            } finally {
                generateBtn.disabled = false;
                btnText.textContent = 'Tạo Dự án từ cuộc trò chuyện';
                spinner.classList.add('hidden');
                hideLoader();
            }
        }


        // --- UI Helpers: Modals & Loaders ---
        const genericModal = document.getElementById('genericModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const modalActions = document.getElementById('modalActions');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const fullScreenLoader = document.getElementById('fullScreenLoader');
        const loaderText = document.getElementById('loaderText');

        function showLoader(text = 'Đang xử lý...') {
            loaderText.textContent = text;
            fullScreenLoader.classList.remove('hidden');
        }

        function hideLoader() {
            fullScreenLoader.classList.add('hidden');
        }

        function hideModal() {
            genericModal.classList.add('hidden');
            genericModal.querySelector('div').classList.add('scale-95');
        }

        function showModal(title, contentHTML, actions) {
            modalTitle.textContent = title;
            modalContent.innerHTML = contentHTML;
            modalActions.innerHTML = '';
            actions.forEach(action => {
                const button = document.createElement('button');
                button.textContent = action.text;
                button.className = action.class;
                button.onclick = action.handler;
                modalActions.appendChild(button);
            });
            genericModal.classList.remove('hidden');
            setTimeout(() => genericModal.querySelector('div').classList.remove('scale-95'), 10);
        }

        function showAlert(title, message) {
            return new Promise(resolve => {
                showModal(title, `<p class="text-gray-700 whitespace-pre-wrap">${message}</p>`, [
                    { text: 'Đã hiểu', class: 'px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700', handler: () => { hideModal(); resolve(); } }
                ]);
            });
        }

        function showConfirm(title, message) {
            return new Promise(resolve => {
                const cancelHandler = () => { hideModal(); resolve(false); };
                const confirmHandler = () => { hideModal(); resolve(true); };
                
                showModal(title, `<p>${message}</p>`, [
                    { text: 'Hủy', class: 'px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300', handler: cancelHandler },
                    { text: 'Xác nhận', class: 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700', handler: confirmHandler }
                ]);
                modalCloseBtn.onclick = cancelHandler;
            });
        }

        function showPrompt(title, label, defaultValue = '') {
            return new Promise(resolve => {
                const content = `<label for="modalInput" class="block text-sm font-medium text-gray-700">${label}</label>
                                 <input type="text" id="modalInput" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" value="${defaultValue}">`;
                
                const cancelHandler = () => { hideModal(); resolve(null); };
                const confirmHandler = () => {
                    const value = document.getElementById('modalInput').value;
                    hideModal();
                    resolve(value);
                };

                showModal(title, content, [
                    { text: 'Hủy', class: 'px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300', handler: cancelHandler },
                    { text: 'OK', class: 'px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700', handler: confirmHandler }
                ]);
                
                const input = document.getElementById('modalInput');
                input.focus();
                input.select();
                input.onkeydown = (e) => { if (e.key === 'Enter') confirmHandler(); };
                modalCloseBtn.onclick = cancelHandler;
            });
        }


        // --- Event Listeners ---
        function attachAppEventListeners() {
            document.getElementById('logout-btn').addEventListener('click', () => {
                signOut(auth).then(() => {
                    window.location.reload();
                });
            });
            document.getElementById('save-project-btn').addEventListener('click', saveProject);
            document.getElementById('load-project-btn').addEventListener('click', loadProjects);
            document.getElementById('export-code-btn').addEventListener('click', exportProjectAsHtml);
            document.getElementById('closeLoadModalBtn').addEventListener('click', () => document.getElementById('loadProjectModal').classList.add('hidden'));
            fileExplorer.addEventListener('contextmenu', showContextMenu);
            document.addEventListener('click', (e) => {
                if (!contextMenu.contains(e.target)) {
                    hideContextMenu();
                }
            });
            openModalBtn.addEventListener('click', () => {
                previewModal.classList.remove('hidden');
                updatePreview();
                setPreviewMode('desktop');
            });
            closeModalBtn.addEventListener('click', () => {
                previewModal.classList.add('hidden');
            });
            desktopViewBtn.addEventListener('click', () => setPreviewMode('desktop'));
            mobileViewBtn.addEventListener('click', () => setPreviewMode('mobile'));
            
            // New Project Button
            document.getElementById('new-project-btn').addEventListener('click', openNewProjectChatModal);
            document.getElementById('closeNewProjectModalBtn').addEventListener('click', () => newProjectChatModal.classList.add('hidden'));
            document.getElementById('newProjectDiscussBtn').addEventListener('click', handleNewProjectDiscussion);
            document.getElementById('newProjectGenerateBtn').addEventListener('click', handleGenerateProjectFromChat);

            runAiBtn.addEventListener('click', getAiSuggestion);
        }
        
        // Attach auth listeners immediately on load
        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            document.getElementById('auth-error').textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                document.getElementById('auth-error').textContent = error.message;
            }
        });
        document.getElementById('register-btn').addEventListener('click', async () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            document.getElementById('auth-error').textContent = '';
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                document.getElementById('auth-error').textContent = error.message;
            }
        });

    </script>
</body>
</html>
