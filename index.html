<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prototype Động - Sửa code bất kỳ với AI (v7 - Xử lý JSON nâng cao)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    
    <style>
        /* CSS tùy chỉnh cho phong cách Material Design */
        body { 
            font-family: 'Inter', sans-serif; 
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none; }
        
        /* Màu sắc cho code cũ và mới theo Material */
        .code-old { color: #B91C1C; /* red-700 */ }
        .code-new { color: #047857; /* green-700 */ }

        /* Đảm bảo khung xem trước được bo góc và có viền (khác với border trong JS) */
        #previewFrame { 
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem; 
        }
    </style>
</head>
<body class="p-4 md:p-8 bg-gray-100 text-gray-900">

    <div class="max-w-screen-2xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-xl">
        <header class="mb-6 pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-gray-800">Prototype Động: Sửa Code Bất Kỳ Với AI</h1>
            <p class="mt-2 text-gray-600">
                AI sẽ đề xuất một danh sách các thay đổi. Bạn có thể áp dụng từng thay đổi một cách độc lập.
            </p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Cột 1: Trình soạn thảo -->
            <div class="flex flex-col">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">1. Dán mã nguồn của bạn vào đây</h2>
                <div id="editorContainer" class="flex-grow h-96 min-h-[600px] border border-gray-300 rounded-lg shadow-md"></div>
            </div>

            <!-- Cột 2: Điều khiển AI và Trạng thái -->
            <div class="flex flex-col">
                <div class="bg-indigo-50 p-6 rounded-lg border border-indigo-200 h-full">
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">2. Điều khiển AI</h2>
                    <p class="text-sm text-gray-500 mb-4">Nhập yêu cầu của bạn. AI sẽ chia thành các bước nhỏ.</p>
                    <textarea id="aiPromptInput" class="w-full p-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" rows="5" placeholder="Ví dụ: Thay đổi tiêu đề thành 'Xin chào' và đổi màu nền nút Chạy Script thành màu đỏ."></textarea>
                    
                    <button id="runAiBtn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg shadow-md transition duration-300 opacity-50 cursor-not-allowed flex items-center justify-center" disabled>
                        <span id="buttonText">Gửi yêu cầu AI</span>
                        <div id="buttonSpinner" class="spinner hidden ml-3"></div>
                    </button>

                    <h2 class="text-xl font-semibold text-gray-700 mt-8 mb-2">3. Danh sách thay đổi đề xuất</h2>
                     <div id="aiResponseContainer" class="h-96 overflow-y-auto">
                        <p id="aiResponsePlaceholder" class="text-gray-500">Đề xuất của AI sẽ xuất hiện ở đây...</p>
                     </div>

                    <h2 class="text-xl font-semibold text-gray-700 mt-8 mb-2">4. Trạng thái</h2>
                    <div id="status" class="w-full bg-white p-4 rounded-md shadow-inner border text-gray-600 min-h-[50px]">
                        Đang chờ tải trang và các thư viện...
                    </div>
                </div>
            </div>

            <!-- Cột 3: Xem trước (Preview) -->
            <div class="flex flex-col lg:col-span-2 mt-8"> 
                <h2 class="text-xl font-semibold text-gray-700 mb-2">5. Xem trước trực quan</h2>
                <button id="openModalBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                    Xem trước
                </button>
                <div id="previewModal" class="hidden fixed inset-0 z-50 overflow-y-auto overflow-x-hidden flex items-center justify-center bg-gray-900 bg-opacity-75">
                    <div class="relative w-full h-[90vh] max-w-7xl mx-auto p-4 flex flex-col">
                        <div class="relative bg-white rounded-lg shadow-xl flex flex-col flex-grow">
                            <button type="button" class="absolute top-3 right-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" data-modal-toggle="previewModal">
                                <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                                <span class="sr-only">Close modal</span>
                            </button>
                            <div class="p-6 flex flex-col flex-grow">
                                <div id="previewControls" class="flex justify-center mb-4 space-x-4">
                                    <button id="desktopViewBtn" class="px-5 py-2 rounded-lg shadow-md transition duration-300 font-medium text-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9.75 14.25L13.5 14.25L13.5 17M14.25 10.5V7.5C14.25 6.402 13.348 5.5 12.25 5.5H5.75C4.652 5.5 3.75 6.402 3.75 7.5V16.5C3.75 17.598 4.652 18.5 5.75 18.5H12.25C13.348 18.5 14.25 17.598 14.25 16.5V13.5M20.25 10.5V7.5C20.25 6.402 19.348 5.5 18.25 5.5H11.75C10.652 5.5 9.75 6.402 9.75 7.5V16.5C9.75 17.598 10.652 18.5 11.75 18.5H18.25C19.348 18.5 20.25 17.598 20.25 16.5V13.5"/>
                                        </svg>
                                        <span>Desktop</span>
                                    </button>
                                    <button id="mobileViewBtn" class="px-5 py-2 rounded-lg shadow-md transition duration-300 font-medium text-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4a2 2 0 012-2h6a2 2 0 012 2v12m-6 4a2 2 0 11-4 0 2 2 0 014 0zM12 22a2 2 0 100-4 2 2 0 000 4z"/>
                                        </svg>
                                        <span>Mobile</span>
                                    </button>
                                </div>
                                <div id="previewFrameContainer" class="flex-grow flex justify-center items-center overflow-auto bg-gray-50 rounded-lg p-4">
                                    <iframe id="previewFrame" title="Visual Preview" class="border border-gray-300 rounded-lg shadow-md transition-all duration-300 ease-in-out"></iframe>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <script>
                    const openModalBtn = document.getElementById('openModalBtn');
                    const previewModal = document.getElementById('previewModal');
                    const desktopViewBtn = document.getElementById('desktopViewBtn');
                    const mobileViewBtn = document.getElementById('mobileViewBtn');
                    const previewFrameContainer = document.getElementById('previewFrameContainer');
                    const previewFrame = document.getElementById('previewFrame'); // Đảm bảo lấy lại tham chiếu

                    openModalBtn.addEventListener('click', () => {
                        previewModal.classList.remove('hidden');
                        updatePreview();
                        setPreviewMode('desktop'); // Mặc định hiển thị chế độ desktop khi mở modal
                    });
                    document.getElementById('previewModal').querySelector('button[data-modal-toggle="previewModal"]').addEventListener('click', () => {
                        previewModal.classList.add('hidden');
                    });

                    // Hàm chuyển đổi chế độ xem (Desktop/Mobile)
                    function setPreviewMode(mode) {
                        // Reset trạng thái của tất cả các nút
                        desktopViewBtn.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
                        desktopViewBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                        mobileViewBtn.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
                        mobileViewBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');

                        // Áp dụng trạng thái cho nút và kích thước iframe
                        if (mode === 'desktop') {
                            desktopViewBtn.classList.add('bg-indigo-600', 'text-white', 'shadow-lg');
                            desktopViewBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');

                            previewFrame.style.width = '100%';
                            previewFrame.style.height = '100%'; // Cho phép iframe co giãn theo container
                            previewFrameContainer.classList.remove('items-center'); // Bỏ căn giữa dọc
                            
                        } else if (mode === 'mobile') {
                            mobileViewBtn.classList.add('bg-indigo-600', 'text-white', 'shadow-lg');
                            mobileViewBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');

                            // Kích thước chuẩn của một thiết bị di động (ví dụ: iPhone 6/7/8)
                            previewFrame.style.width = '375px'; 
                            previewFrame.style.height = '667px'; 
                            previewFrameContainer.classList.add('items-center'); // Căn giữa dọc
                        }
                        updatePreview(); // Cập nhật nội dung xem trước
                    }

                    // Gán sự kiện click cho các nút
                    desktopViewBtn.addEventListener('click', () => setPreviewMode('desktop'));
                    mobileViewBtn.addEventListener('click', () => setPreviewMode('mobile'));
                </script>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-ai.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDt6KZTLJ5ItNShxAPlpKKHC8eHiIBSjmY",
            authDomain: "aicodepro-lien.firebaseapp.com",
            projectId: "aicodepro-lien",
            storageBucket: "aicodepro-lien.firebasestorage.app",
            messagingSenderId: "277847908656",
            appId: "1:277847908656:web:77eb210b8e2b2b7dbca8f5"
        };

        let monacoEditor;
        let aiModel;

        const statusEl = document.getElementById('status');
        const runAiBtn = document.getElementById('runAiBtn');
        const previewFrame = document.getElementById('previewFrame');
        const aiPromptInput = document.getElementById('aiPromptInput');
        const aiResponseContainer = document.getElementById('aiResponseContainer');
        const aiResponsePlaceholder = document.getElementById('aiResponsePlaceholder');
        const buttonText = document.getElementById('buttonText');
        const buttonSpinner = document.getElementById('buttonSpinner');
        
        const placeholderCode = `<!-- Dán mã nguồn HTML của bạn vào đây -->
<!DOCTYPE html>
<html>
<head>
    <title>Trang Mẫu</title>
</head>
<body>
    <h1 id="title">Tiêu đề Gốc</h1>
    <button onclick="changeContent()">Chạy Script</button>
    <script>
        function changeContent() {
            // AI sẽ sửa hàm này
            document.getElementById('title').textContent = 'Nội dung Gốc';
        }
    <\/script>
</body>
</html>`;

        window.onload = function() {
            statusEl.textContent = "Đang khởi tạo trình soạn thảo...";
            
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
            require(['vs/editor/editor.main'], function() {
                monacoEditor = monaco.editor.create(document.getElementById('editorContainer'), {
                    value: placeholderCode,
                    language: 'html',
                    theme: 'vs-light',
                    automaticLayout: true,
                    fontSize: 14,
                    wordWrap: 'on'
                });

                monacoEditor.onDidChangeModelContent(() => updatePreview());
                updatePreview();
                statusEl.textContent = "Trình soạn thảo sẵn sàng. Đang khởi tạo AI Model...";
                initializeFirebaseAI();
            });
        };

        function initializeFirebaseAI() {
            try {
                const app = initializeApp(firebaseConfig);
                const ai = getAI(app, { backend: new GoogleAIBackend() });
                aiModel = getGenerativeModel(ai, { model: "gemini-1.5-flash-latest" });
                
                statusEl.textContent = "Hệ thống đã sẵn sàng. Hãy dán code và ra lệnh cho AI.";
                runAiBtn.disabled = false;
                runAiBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                runAiBtn.addEventListener('click', getAiSuggestion);

            } catch (e) {
                console.error("Lỗi khi khởi tạo AI Model:", e);
                statusEl.innerHTML = `Lỗi khởi tạo AI Model: ${e.message}.<br>Hãy chắc rằng bạn đã thay thế firebaseConfig và kích hoạt AI cho dự án.`;
                statusEl.classList.add('text-red-500');
            }
        }

        async function getAiSuggestion() {
            const userPrompt = aiPromptInput.value.trim();
            if (!userPrompt) {
                statusEl.textContent = "Vui lòng nhập yêu cầu cho AI.";
                statusEl.classList.add('text-red-500');
                return;
            }

            setLoadingState(true);
            statusEl.textContent = "1. Đang gửi yêu cầu đến Gemini để phân tích...";
            aiResponseContainer.innerHTML = '';
            aiResponsePlaceholder.textContent = "Đang chờ phản hồi...";
            aiResponseContainer.appendChild(aiResponsePlaceholder);

            try {
                const fullHtmlCode = monacoEditor.getValue();
                
                // --- LỜI NHẮC AI ĐƯỢC CẬP NHẬT THEO PHÂN TÍCH ---
                const finalPrompt = `
You are an expert code modification assistant. Your task is to break down a user's request into a series of small, specific code replacements.
You must analyze the user's request and the provided source code, then generate a list of changes.

SOURCE CODE:
\`\`\`html
${fullHtmlCode}
\`\`\`

USER'S REQUEST:
"${userPrompt}"

TASK:
Generate a single JSON object containing a list of changes.
**You MUST wrap the final JSON object in a markdown code block like this: \`\`\`json ... \`\`\`**

The JSON object must have a single key "changes", which is an array.
Each object in the "changes" array must have three keys:
1.  "description": A brief, user-friendly description of the change in Vietnamese.
2.  "oldCode": The exact, contiguous block of code to be replaced. This must be found in the source code.
3.  "newCode": The new block of code that will replace the old one.

**IMPORTANT RULES:**
- Only return the JSON object, wrapped in the \`\`\`json ... \`\`\` block. No other text or markdown.
- The "oldCode" must be an exact substring from the provided source code.
- If the user's request is unclear or cannot be translated into specific code changes, return an empty "changes" array.
`;

                const result = await aiModel.generateContent(finalPrompt);
                const responseText = result.response.text();
                
                // --- BƯỚC 2: TRÍCH XUẤT KHỐI JSON ---
                const jsonString = extractJsonBlock(responseText);
                if (!jsonString) {
                    throw new Error("Không tìm thấy khối JSON hợp lệ trong phản hồi của AI.");
                }
                
                // --- BƯỚC 4: PHÂN TÍCH JSON ---
                const aiResponse = JSON.parse(jsonString);
                
                if (!aiResponse.changes || !Array.isArray(aiResponse.changes)) {
                    throw new Error("Phản hồi của AI không đúng định dạng JSON yêu cầu (thiếu key 'changes' hoặc không phải là mảng).");
                }
                
                // --- BƯỚC 5 & 6: RENDER VÀ CHÈN VÀO DOM ---
                renderChangeList(aiResponse.changes);

            } catch (error) {
                console.error("Lỗi trong quá trình lấy đề xuất AI:", error);
                statusEl.textContent = `Đã xảy ra lỗi: ${error.message}`;
                statusEl.classList.add('text-red-500');
                aiResponsePlaceholder.textContent = `Lỗi: ${error.message}`;
            } finally {
                setLoadingState(false);
            }
        }

        // HÀM MỚI: Trích xuất khối JSON từ phản hồi của AI
        function extractJsonBlock(text) {
            const match = text.match(/```json\s*([\s\S]*?)\s*```/);
            if (match && match[1]) {
                return match[1].trim();
            }
            // Fallback: Nếu không có khối markdown, thử tìm đối tượng JSON thô
            const rawJsonMatch = text.match(/{\s*"changes":\s*\[[\s\S]*\]\s*}/);
            if(rawJsonMatch && rawJsonMatch[0]) {
                return rawJsonMatch[0].trim();
            }
            console.error("Không thể trích xuất JSON. Phản hồi thô:", text);
            return null;
        }
        
        function renderChangeList(changes) {
            aiResponseContainer.innerHTML = ''; // Xóa placeholder
            
            if (changes.length === 0) {
                aiResponsePlaceholder.textContent = "AI không tìm thấy thay đổi nào có thể thực hiện từ yêu cầu của bạn.";
                aiResponseContainer.appendChild(aiResponsePlaceholder);
                statusEl.textContent = "Sẵn sàng cho yêu cầu mới.";
                return;
            }

            statusEl.innerHTML = `<b>AI đã đề xuất ${changes.length} thay đổi. Vui lòng xem lại và áp dụng.</b>`;
            statusEl.classList.remove('text-red-500');
            statusEl.classList.add('text-blue-600');

            changes.forEach((change, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 mb-4 rounded-lg shadow-md'; 

                card.innerHTML = `
                    <p class="font-semibold text-gray-800">${index + 1}. ${change.description}</p>
                    <div class="mt-2">
                        <p class="text-sm font-medium text-gray-500">Code cũ:</p>
                        <pre class="code-old"><code></code></pre>
                    </div>
                    <div class="mt-2">
                        <p class="text-sm font-medium text-gray-500">Code mới:</p>
                        <pre class="code-new"><code></code></pre>
                    </div>
                    <button class="apply-change-btn mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        [✓] Áp dụng thay đổi này
                    </button>
                `;
                
                card.querySelector('.code-old code').textContent = change.oldCode;
                card.querySelector('.code-new code').textContent = change.newCode;

                const applyBtn = card.querySelector('.apply-change-btn');
                applyBtn.addEventListener('click', () => {
                    applySingleChange(change.oldCode, change.newCode, applyBtn);
                });

                aiResponseContainer.appendChild(card);
            });
        }

        function applySingleChange(oldCode, newCode, button) {
            const editorModel = monacoEditor.getModel();
            const matches = editorModel.findMatches(oldCode, false, false, true, null, true);

            if (matches.length > 0) {
                const range = matches[0].range;
                const op = { range: range, text: newCode };
                monacoEditor.executeEdits("ai-replace-single", [op]);

                button.textContent = 'Đã áp dụng';
                button.disabled = true;
                button.classList.remove('bg-green-600', 'hover:bg-green-700');
                button.classList.add('bg-gray-400', 'cursor-not-allowed');
                statusEl.textContent = "Áp dụng thay đổi thành công!";
                statusEl.classList.add('text-green-600');
            } else {
                alert(`Không tìm thấy đoạn mã cũ trong trình soạn thảo:\n\n${oldCode}`);
                statusEl.textContent = "Lỗi: Không tìm thấy mã cũ để thay thế.";
                statusEl.classList.add('text-red-500');
            }
        }

        function updatePreview() {
            try {
                const code = monacoEditor.getValue();
                previewFrame.srcdoc = code;
            } catch (e) { /* Bỏ qua lỗi nhỏ */ }
        }

        function setLoadingState(isLoading) {
            runAiBtn.disabled = isLoading;
            if (isLoading) {
                buttonText.textContent = 'Đang xử lý...';
                buttonSpinner.classList.remove('hidden');
            } else {
                buttonText.textContent = 'Gửi yêu cầu AI';
                buttonSpinner.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
```
