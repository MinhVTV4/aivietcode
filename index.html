<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prototype ƒê·ªông - S·ª≠a code b·∫•t k·ª≥ v·ªõi AI (v21.3 - Ho√†n thi·ªán)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-left-color: #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none; }
        .file-explorer-item { display: flex; align-items: center; padding: 4px 8px; cursor: pointer; border-radius: 4px; user-select: none; }
        .file-explorer-item:hover { background-color: #eef2ff; }
        .file-explorer-item.active { background-color: #c7d2fe; }
        .file-explorer-item svg { width: 16px; height: 16px; margin-right: 8px; flex-shrink: 0; }
        .folder-arrow { transition: transform 0.1s linear; }
        .folder-arrow.open { transform: rotate(90deg); }
        #contextMenu { position: absolute; z-index: 1000; background-color: white; border: 1px solid #e5e7eb; border-radius: 0.375rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 0.5rem 0; min-width: 150px; }
        .context-menu-item { display: block; width: 100%; padding: 0.5rem 1rem; font-size: 0.875rem; text-align: left; }
        .context-menu-item:hover { background-color: #f3f4f6; }
        .code-old { color: #B91C1C; }
        .code-new { color: #047857; }
        .change-group-header { font-weight: 600; margin-top: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Auth Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</h2>
            <div id="auth-error" class="text-red-500 text-sm mb-4 text-center h-4"></div>
            <div class="space-y-4">
                <input id="email-input" type="email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input id="password-input" type="password" placeholder="M·∫≠t kh·∫©u" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <div class="flex gap-4">
                    <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">ƒêƒÉng nh·∫≠p</button>
                    <button id="register-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">ƒêƒÉng k√Ω</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application (hidden by default) -->
    <div id="main-app" class="hidden p-4 md:p-8">
        <div class="max-w-screen-2xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-xl">
            <header class="mb-6 pb-4 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Prototype ƒê·ªông: <span id="project-name-display">D·ª± √°n M·ªõi</span></h1>
                    <p id="user-email" class="text-sm text-gray-500 mt-1"></p>
                </div>
                <div class="flex gap-2">
                    <button id="new-project-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">D·ª± √°n M·ªõi</button>
                    <button id="save-project-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">L∆∞u d·ª± √°n</button>
                    <button id="load-project-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">M·ªü d·ª± √°n</button>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">ƒêƒÉng xu·∫•t</button>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- C·ªôt 1: Tr√¨nh so·∫°n th·∫£o -->
                <div class="flex flex-col">
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">1. D·ª± √°n</h2>
                    <div class="flex flex-grow border border-gray-300 rounded-lg shadow-md min-h-[600px]">
                        <div id="fileExplorer" class="w-1/3 max-w-xs bg-gray-50 p-2 border-r border-gray-300 overflow-y-auto"></div>
                        <div id="editorContainer" class="flex-grow"></div>
                    </div>
                </div>

                <!-- C·ªôt 2: AI v√† c√°c ch·ª©c nƒÉng kh√°c -->
                <div class="flex flex-col">
                    <div class="bg-indigo-50 p-6 rounded-lg border border-indigo-200 h-full">
                         <div class="flex justify-between items-center">
                            <h2 class="text-xl font-semibold text-gray-700">2. ƒêi·ªÅu khi·ªÉn AI</h2>
                            <button id="openIdeaModalBtn" title="Kh·ªüi t·∫°o D·ª± √°n t·ª´ √ù t∆∞·ªüng" class="bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-bold p-2 rounded-full shadow-md transition duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a1 1 0 011 1v1.01a5.002 5.002 0 014.37 4.373H16a1 1 0 110 2h-1.01a5.002 5.002 0 01-4.37 4.373V17a1 1 0 11-2 0v-1.01a5.002 5.002 0 01-4.37-4.373H4a1 1 0 110-2h1.01A5.002 5.002 0 019.38 3.01V2a1 1 0 011-1zM4 10a6 6 0 1112 0 6 6 0 01-12 0z" /></svg>
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 mb-4">Nh·∫≠p y√™u c·∫ßu c·ªßa b·∫°n, ho·∫∑c d√πng Tr·ª£ l√Ω Kh·ªüi t·∫°o (üí°) ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
                        <textarea id="aiPromptInput" class="w-full p-2 border rounded-md" rows="5"></textarea>
                        
                        <!-- FOCUS MODE CHECKBOX -->
                        <div class="mt-2 flex items-center">
                            <input id="focus-mode-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="focus-mode-checkbox" class="ml-2 block text-sm text-gray-900">Ch·ªâ l√†m vi·ªác tr√™n v√πng ƒë√£ ch·ªçn</label>
                        </div>

                        <button id="runAiBtn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg flex items-center justify-center">
                            <span id="buttonText">G·ª≠i y√™u c·∫ßu AI</span>
                            <div id="buttonSpinner" class="spinner hidden ml-3"></div>
                        </button>
                        <h2 class="text-xl font-semibold text-gray-700 mt-8 mb-2">3. ƒê·ªÅ xu·∫•t c·ªßa AI</h2>
                        <div id="aiResponseContainer" class="h-96 overflow-y-auto">
                            <p id="aiResponsePlaceholder" class="text-gray-500">ƒê·ªÅ xu·∫•t c·ªßa AI s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y...</p>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-700 mt-8 mb-2">4. Tr·∫°ng th√°i</h2>
                        <div id="status" class="w-full bg-white p-4 rounded-md shadow-inner border text-gray-600 min-h-[50px]"></div>
                    </div>
                </div>
                 <!-- C·ªôt 3: Xem tr∆∞·ªõc (Preview) -->
                <div class="flex flex-col lg:col-span-2 mt-8"> 
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">5. Xem tr∆∞·ªõc tr·ª±c quan</h2>
                    <button id="openModalBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">Xem tr∆∞·ªõc</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="contextMenu" class="hidden"></div>
    <div id="previewModal" class="hidden fixed inset-0 z-50 overflow-y-auto overflow-x-hidden flex items-center justify-center bg-gray-900 bg-opacity-75">
        <div class="relative w-full h-[90vh] max-w-7xl mx-auto p-4 flex flex-col">
            <div class="relative bg-white rounded-lg shadow-xl flex flex-col flex-grow">
                <button type="button" id="closeModalBtn" class="absolute top-3 right-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
                <div class="p-6 flex flex-col flex-grow">
                    <div id="previewControls" class="flex justify-center mb-4 space-x-4">
                        <button id="desktopViewBtn" class="px-5 py-2 rounded-lg shadow-md">Desktop</button>
                        <button id="mobileViewBtn" class="px-5 py-2 rounded-lg shadow-md">Mobile</button>
                    </div>
                    <div id="previewFrameContainer" class="flex-grow flex justify-center items-center overflow-auto bg-gray-50 rounded-lg p-4">
                        <iframe id="previewFrame" title="Visual Preview" class="border border-gray-300 rounded-lg shadow-md"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="ideaModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-semibold text-gray-800">Tr·ª£ l√Ω Kh·ªüi t·∫°o D·ª± √°n</h3>
                <button id="closeIdeaModalBtn" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <textarea id="ideaInput" rows="3" class="w-full p-2 border rounded-md" placeholder="V√≠ d·ª•: ·ª©ng d·ª•ng web v·ªÅ m√¥ ph·ªèng th√≠ nghi·ªám h√≥a h·ªçc"></textarea>
                <button id="generatePromptBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                    <span id="generateBtnText">T·∫°o K·∫ø ho·∫°ch</span>
                    <div id="generateSpinner" class="spinner hidden ml-3"></div>
                </button>
                <textarea id="generatedPromptOutput" rows="10" class="w-full p-2 border rounded-md bg-gray-50" readonly></textarea>
                <button id="copyAndPasteBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Sao ch√©p & D√°n</button>
            </div>
        </div>
    </div>
    <div id="loadProjectModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="load-modal-title" class="text-xl font-semibold text-gray-800">M·ªü D·ª± √°n</h3>
                <button id="closeLoadModalBtn" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="load-modal-content" class="p-6 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-ai.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, query, where, orderBy, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDt6KZTLJ5ItNShxAPlpKKHC8eHiIBSjmY",
            authDomain: "aicodepro-lien.firebaseapp.com",
            projectId: "aicodepro-lien",
            storageBucket: "aicodepro-lien.firebasestorage.app",
            messagingSenderId: "277847908656",
            appId: "1:277847908656:web:77eb210b8e2b2b7dbca8f5"
        };

        // --- App State ---
        let monacoEditor, aiModel, auth, db;
        let activeFilePath = 'index.html';
        let projectStructure = {};
        let projectModels = {};
        let currentUser = null;
        let isEditorInitialized = false;
        let undoStacks = {};
        let currentProjectId = null;
        let currentProjectName = null;

        // --- DOM Elements ---
        const authScreen = document.getElementById('auth-screen');
        const mainApp = document.getElementById('main-app');
        const fileExplorer = document.getElementById('fileExplorer');
        const editorContainer = document.getElementById('editorContainer');
        const contextMenu = document.getElementById('contextMenu');
        const statusEl = document.getElementById('status');
        const runAiBtn = document.getElementById('runAiBtn');
        const openModalBtn = document.getElementById('openModalBtn');
        const aiResponseContainer = document.getElementById('aiResponseContainer');
        const aiResponsePlaceholder = document.getElementById('aiResponsePlaceholder');
        const previewModal = document.getElementById('previewModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const desktopViewBtn = document.getElementById('desktopViewBtn');
        const mobileViewBtn = document.getElementById('mobileViewBtn');
        const openIdeaModalBtn = document.getElementById('openIdeaModalBtn');
        const ideaModal = document.getElementById('ideaModal');
        const closeIdeaModalBtn = document.getElementById('closeIdeaModalBtn');
        const generatePromptBtn = document.getElementById('generatePromptBtn');
        const copyAndPasteBtn = document.getElementById('copyAndPasteBtn');
        const focusModeCheckbox = document.getElementById('focus-mode-checkbox');

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        
        // --- Auth Logic ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                authScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                document.getElementById('user-email').textContent = `Ch√†o, ${user.email}`;
                if (!isEditorInitialized) {
                    initializeEditorAndAI();
                }
            } else {
                currentUser = null;
                authScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
        });
        
        // --- Editor & App Initialization ---
        function initializeEditorAndAI() {
            statusEl.textContent = "ƒêang kh·ªüi t·∫°o tr√¨nh so·∫°n th·∫£o...";
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
            require(['vs/editor/editor.main'], () => {
                loadInitialProject();
                monacoEditor = monaco.editor.create(editorContainer, {
                    model: projectModels[activeFilePath],
                    theme: 'vs-light',
                    automaticLayout: true
                });
                renderFileExplorer();
                updatePreview();
                attachAppEventListeners();
                
                try {
                    aiModel = getGenerativeModel(getAI(app), { model: "gemini-2.5-flash" });
                    statusEl.textContent = "H·ªá th·ªëng ƒë√£ s·∫µn s√†ng.";
                } catch (e) {
                    statusEl.textContent = `L·ªói kh·ªüi t·∫°o AI: ${e.message}`;
                }
                isEditorInitialized = true;
            });
        }

        function loadInitialProject() {
            Object.values(projectModels).forEach(model => model.dispose());
            projectModels = {};
            currentProjectId = null;
            currentProjectName = "D·ª± √°n M·ªõi";
            updateProjectDisplay();

            projectStructure = {
                'index.html': { type: 'file' },
                'src': { type: 'folder', isOpen: true, children: {
                    'css': { type: 'folder', isOpen: true, children: { 'style.css': { type: 'file' } } },
                    'js': { type: 'folder', isOpen: true, children: { 'script.js': { type: 'file' } } }
                }}
            };
            const sampleFiles = {
                'index.html': `<!DOCTYPE html>\n<html lang="en">\n<head>\n    <title>D·ª± √°n M·ªõi</title>\n    <link rel="stylesheet" href="src/css/style.css">\n</head>\n<body>\n    <h1>Ch√†o m·ª´ng!</h1>\n    <script src="src/js/script.js"><\/script>\n</body>\n</html>`,
                'src/css/style.css': `body {\n    font-family: sans-serif;\n}`,
                'src/js/script.js': `console.log("Hello World!");`
            };
            createModelsFromStructure(projectStructure, sampleFiles);
            activeFilePath = 'index.html';
            if(monacoEditor) {
                monacoEditor.setModel(projectModels[activeFilePath]);
                renderFileExplorer();
                updatePreview();
            }
        }

        // --- Firestore Logic ---
        async function saveProject() {
            const files = {};
            Object.entries(projectModels).forEach(([path, model]) => {
                files[path] = model.getValue();
            });

            if (currentProjectId) {
                // Save a new version
                const commitMessage = prompt("Nh·∫≠p ghi ch√∫ cho phi√™n b·∫£n n√†y (v√≠ d·ª•: 'Th√™m n√∫t ƒëƒÉng nh·∫≠p'):", "");
                if (commitMessage === null) return;

                statusEl.textContent = "ƒêang l∆∞u phi√™n b·∫£n m·ªõi...";
                try {
                    const projectRef = doc(db, "projects", currentProjectId);
                    const projectSnap = await getDoc(projectRef);
                    const currentVersion = projectSnap.data().latestVersion || 0;
                    const newVersionNumber = currentVersion + 1;

                    const versionRef = collection(db, "projects", currentProjectId, "versions");
                    await addDoc(versionRef, {
                        versionNumber: newVersionNumber,
                        commitMessage: commitMessage,
                        structure: JSON.stringify(projectStructure),
                        files: files,
                        createdAt: serverTimestamp()
                    });

                    await updateDoc(projectRef, {
                        latestVersion: newVersionNumber,
                        lastUpdatedAt: serverTimestamp()
                    });
                    
                    statusEl.textContent = `ƒê√£ l∆∞u phi√™n b·∫£n ${newVersionNumber} cho d·ª± √°n "${currentProjectName}".`;

                } catch (error) {
                    console.error("L·ªói khi l∆∞u phi√™n b·∫£n m·ªõi:", error);
                    statusEl.textContent = "L·ªói khi l∆∞u phi√™n b·∫£n m·ªõi.";
                }

            } else {
                // Save a new project
                const projectName = prompt("Nh·∫≠p t√™n d·ª± √°n m·ªõi:");
                if (!projectName) return;

                statusEl.textContent = "ƒêang t·∫°o d·ª± √°n m·ªõi...";
                try {
                    const projectRef = await addDoc(collection(db, "projects"), {
                        uid: currentUser.uid,
                        name: projectName,
                        createdAt: serverTimestamp(),
                        lastUpdatedAt: serverTimestamp(),
                        latestVersion: 1
                    });

                    const versionRef = collection(db, "projects", projectRef.id, "versions");
                    await addDoc(versionRef, {
                        versionNumber: 1,
                        commitMessage: "Phi√™n b·∫£n ƒë·∫ßu ti√™n",
                        structure: JSON.stringify(projectStructure),
                        files: files,
                        createdAt: serverTimestamp()
                    });

                    currentProjectId = projectRef.id;
                    currentProjectName = projectName;
                    updateProjectDisplay();
                    statusEl.textContent = `ƒê√£ t·∫°o v√† l∆∞u d·ª± √°n "${projectName}" th√†nh c√¥ng.`;

                } catch (error) {
                    console.error("L·ªói khi t·∫°o d·ª± √°n m·ªõi:", error);
                    statusEl.textContent = "L·ªói khi t·∫°o d·ª± √°n m·ªõi.";
                }
            }
        }

        async function loadProjects() {
            const modalContent = document.getElementById('load-modal-content');
            modalContent.innerHTML = '<div class="spinner"></div>';
            document.getElementById('load-modal-title').textContent = "M·ªü D·ª± √°n";
            document.getElementById('loadProjectModal').classList.remove('hidden');

            const q = query(collection(db, "projects"), where("uid", "==", currentUser.uid), orderBy("lastUpdatedAt", "desc"));
            const querySnapshot = await getDocs(q);
            
            modalContent.innerHTML = '';
            if (querySnapshot.empty) {
                modalContent.textContent = "B·∫°n ch∆∞a c√≥ d·ª± √°n n√†o.";
                return;
            }
            querySnapshot.forEach((doc) => {
                const project = doc.data();
                const div = document.createElement('div');
                div.className = "p-2 hover:bg-gray-100 cursor-pointer rounded";
                div.textContent = project.name;
                div.onclick = () => showProjectVersions(doc.id, project.name);
                modalContent.appendChild(div);
            });
        }

        async function showProjectVersions(projectId, projectName) {
            const modalContent = document.getElementById('load-modal-content');
            modalContent.innerHTML = '<div class="spinner"></div>';
            document.getElementById('load-modal-title').textContent = `Phi√™n b·∫£n c·ªßa "${projectName}"`;
            
            const backButton = document.createElement('button');
            backButton.className = "mb-4 text-sm text-indigo-600 hover:underline";
            backButton.textContent = "‚Üê Quay l·∫°i danh s√°ch d·ª± √°n";
            backButton.onclick = loadProjects;
            
            const versionsList = document.createElement('div');
            
            modalContent.innerHTML = '';
            modalContent.appendChild(backButton);
            modalContent.appendChild(versionsList);
            
            const q = query(collection(db, "projects", projectId, "versions"), orderBy("versionNumber", "desc"));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                versionsList.textContent = "D·ª± √°n n√†y ch∆∞a c√≥ phi√™n b·∫£n n√†o.";
                return;
            }
            querySnapshot.forEach((doc) => {
                const version = doc.data();
                const div = document.createElement('div');
                div.className = "p-2 hover:bg-gray-100 cursor-pointer rounded border-b";
                div.innerHTML = `
                    <p class="font-semibold">Phi√™n b·∫£n ${version.versionNumber}</p>
                    <p class="text-sm text-gray-600">${version.commitMessage}</p>
                    <p class="text-xs text-gray-400">${version.createdAt ? version.createdAt.toDate().toLocaleString() : 'N/A'}</p>
                `;
                div.onclick = () => openProjectVersion(projectId, projectName, doc.id);
                versionsList.appendChild(div);
            });
        }

        async function openProjectVersion(projectId, projectName, versionId) {
            statusEl.textContent = `ƒêang m·ªü d·ª± √°n...`;
            document.getElementById('loadProjectModal').classList.add('hidden');
            const docRef = doc(db, "projects", projectId, "versions", versionId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const versionData = docSnap.data();
                Object.values(projectModels).forEach(model => model.dispose());
                projectModels = {};

                projectStructure = JSON.parse(versionData.structure);
                createModelsFromStructure(projectStructure, versionData.files);
                
                currentProjectId = projectId;
                currentProjectName = projectName;
                updateProjectDisplay();

                activeFilePath = 'index.html';
                monacoEditor.setModel(projectModels[activeFilePath]);
                renderFileExplorer();
                updatePreview();
                statusEl.textContent = `ƒê√£ m·ªü d·ª± √°n "${projectName}", phi√™n b·∫£n ${versionData.versionNumber}.`;
            } else {
                statusEl.textContent = "Kh√¥ng t√¨m th·∫•y phi√™n b·∫£n d·ª± √°n.";
            }
        }
        
        function updateProjectDisplay() {
            document.getElementById('project-name-display').textContent = currentProjectName;
            const saveBtn = document.getElementById('save-project-btn');
            if (currentProjectId) {
                saveBtn.textContent = "L∆∞u phi√™n b·∫£n m·ªõi";
            } else {
                saveBtn.textContent = "L∆∞u d·ª± √°n";
            }
        }

        // --- Helper Functions ---
        function createModelsFromStructure(structure, files, pathPrefix = '') {
            Object.entries(structure).forEach(([name, item]) => {
                const currentPath = pathPrefix ? `${pathPrefix}/${name}` : name;
                if (item.type === 'file') {
                    const model = monaco.editor.createModel(
                        files[currentPath] || "",
                        getLanguageForFile(currentPath)
                    );
                    model.onDidChangeContent(updatePreview);
                    projectModels[currentPath] = model;
                } else if (item.children) {
                    createModelsFromStructure(item.children, files, currentPath);
                }
            });
        }
        
        // --- Core Logic & File Management ---
        function getLanguageForFile(filename) {
            const extension = filename.split('.').pop();
            switch (extension) {
                case 'js': return 'javascript';
                case 'css': return 'css';
                case 'html': return 'html';
                default: return 'plaintext';
            }
        }

        function findItemAndParentByPath(path) {
            if (!path) return { item: null, parent: null, key: null };
            const parts = path.split('/');
            let currentLevel = projectStructure;
            let parent = { children: projectStructure };
            let currentItem = null;

            for (let i = 0; i < parts.length; i++) {
                const key = parts[i];
                if (!currentLevel || !currentLevel[key]) return { item: null, parent: null, key: null };
                
                if (i === parts.length - 1) {
                    currentItem = currentLevel[key];
                    parent = (i === 0) ? null : findItemByPath(parts.slice(0, i).join('/'))?.item;
                    return { item: currentItem, parent: parent?.children || projectStructure, key: key };
                }
                currentLevel = currentLevel[key].children;
            }
            return { item: null, parent: null, key: null };
        }

        function findItemByPath(path) {
            if (!path) return { item: projectStructure };
            const parts = path.split('/');
            let currentItem = projectStructure;
            for (const part of parts) {
                if (!currentItem) return { item: null };
                currentItem = currentItem.children ? currentItem.children[part] : currentItem[part];
            }
            return { item: currentItem };
        }
        
        function renderFileExplorer() {
            fileExplorer.innerHTML = '';
            const rootUl = document.createElement('ul');
            
            function createTree(structure, parentElement, pathPrefix = '') {
                Object.entries(structure).forEach(([name, item]) => {
                    const currentPath = pathPrefix ? `${pathPrefix}/${name}` : name;
                    const li = document.createElement('li');
                    li.dataset.path = currentPath;
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'file-explorer-item';
                    itemDiv.dataset.path = currentPath;
                    if (currentPath === activeFilePath) itemDiv.classList.add('active');
                    
                    if (item.type === 'folder') {
                        itemDiv.innerHTML = `<svg class="folder-arrow ${item.isOpen ? 'open' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg><svg fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path></svg><span>${name}</span>`;
                        itemDiv.addEventListener('click', (e) => { e.stopPropagation(); toggleFolder(item); });
                        li.appendChild(itemDiv);
                        if (item.isOpen && item.children) {
                            const childrenUl = document.createElement('ul');
                            childrenUl.style.paddingLeft = '16px';
                            createTree(item.children, childrenUl, currentPath);
                            li.appendChild(childrenUl);
                        }
                    } else {
                        itemDiv.innerHTML = `<svg style="margin-left: 16px;" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h2a2 2 0 002-2V4a2 2 0 00-2-2H9z"></path><path d="M4 12a2 2 0 012-2h1v4a2 2 0 002 2h1v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-4z"></path></svg><span>${name}</span>`;
                        itemDiv.addEventListener('click', (e) => { e.stopPropagation(); switchFile(currentPath); });
                        li.appendChild(itemDiv);
                    }
                    parentElement.appendChild(li);
                });
            }
            createTree(projectStructure, rootUl);
            fileExplorer.appendChild(rootUl);
        }

        function showContextMenu(e) {
            e.preventDefault();
            const target = e.target.closest('[data-path], #fileExplorer');
            const path = target.dataset.path || '';

            let menuItems = '';
            const { item } = findItemAndParentByPath(path);
            const targetType = item ? item.type : 'root';

            if (targetType === 'file') {
                menuItems = `<button class="context-menu-item" onclick="window.handleRename('${path}')">Rename</button>
                             <button class="context-menu-item" onclick="window.handleDelete('${path}')">Delete</button>`;
            } else { // Folder or root
                menuItems = `<button class="context-menu-item" onclick="window.handleNewFile('${path}')">New File</button>
                             <button class="context-menu-item" onclick="window.handleNewFolder('${path}')">New Folder</button>`;
                if (targetType === 'folder') {
                    menuItems += `<div class="context-menu-separator"></div>
                                  <button class="context-menu-item" onclick="window.handleRename('${path}')">Rename</button>
                                  <button class="context-menu-item" onclick="window.handleDelete('${path}')">Delete</button>`;
                }
            }
            
            contextMenu.innerHTML = menuItems;
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.top = `${e.pageY}px`;
            contextMenu.classList.remove('hidden');
        }

        function hideContextMenu() {
            contextMenu.classList.add('hidden');
        }

        // --- File Operations ---
        window.handleNewFile = (parentPath) => {
            hideContextMenu();
            const filename = prompt("Enter new file name:");
            if (!filename) return;

            const newPath = parentPath ? `${parentPath}/${filename}` : filename;
            const { item: parentItem } = findItemByPath(parentPath);
            const targetChildren = parentPath ? parentItem.children : projectStructure;

            if (targetChildren[filename]) {
                alert("A file or folder with this name already exists.");
                return;
            }
            
            targetChildren[filename] = { type: 'file' };
            projectModels[newPath] = monaco.editor.createModel("", getLanguageForFile(filename));
            projectModels[newPath].onDidChangeContent(updatePreview);
            renderFileExplorer();
            switchFile(newPath);
        };

        window.handleNewFolder = (parentPath) => {
            hideContextMenu();
            const foldername = prompt("Enter new folder name:");
            if (!foldername) return;

            const { item: parentItem } = findItemByPath(parentPath);
            const targetChildren = parentPath ? parentItem.children : projectStructure;

            if (targetChildren[foldername]) {
                alert("A file or folder with this name already exists.");
                return;
            }

            targetChildren[foldername] = { type: 'folder', isOpen: true, children: {} };
            renderFileExplorer();
        };

        window.handleRename = (path) => {
            hideContextMenu();
            const { item, parent, key } = findItemAndParentByPath(path);
            if (!item) return;

            const newName = prompt("Enter new name:", key);
            if (!newName || newName === key) return;
            
            if (parent[newName]) {
                alert("A file or folder with this name already exists.");
                return;
            }

            parent[newName] = item;
            delete parent[key];

            if (item.type === 'file') {
                const newPath = path.substring(0, path.lastIndexOf('/') + 1) + newName;
                projectModels[newPath] = projectModels[path];
                delete projectModels[path];
                if(activeFilePath === path) activeFilePath = newPath;
            } else { 
                function updateChildPaths(oldPathPrefix, newPathPrefix) {
                    Object.keys(projectModels).forEach(p => {
                        if (p.startsWith(oldPathPrefix + '/')) {
                            const newP = newPathPrefix + p.substring(oldPathPrefix.length);
                            projectModels[newP] = projectModels[p];
                            delete projectModels[p];
                            if(activeFilePath === p) activeFilePath = newP;
                        }
                    });
                }
                const newPath = path.substring(0, path.lastIndexOf('/') + 1) + newName;
                updateChildPaths(path, newPath);
            }
            
            renderFileExplorer();
        };

        window.handleDelete = (path, skipConfirm = false) => {
            hideContextMenu();
            const { item, parent, key } = findItemAndParentByPath(path);
            if (!item || (!skipConfirm && !confirm(`Are you sure you want to delete "${key}"?`))) return;

            delete parent[key];

            function deleteRecursive(p) {
                if (projectModels[p]) {
                    projectModels[p].dispose();
                    delete projectModels[p];
                }
                Object.keys(projectModels).forEach(childPath => {
                    if (childPath.startsWith(p + '/')) {
                        projectModels[childPath].dispose();
                        delete projectModels[childPath];
                    }
                });
            }
            deleteRecursive(path);

            if (activeFilePath.startsWith(path)) {
                switchFile('index.html');
            }

            renderFileExplorer();
        };

        function toggleFolder(folderItem) {
            folderItem.isOpen = !folderItem.isOpen;
            renderFileExplorer();
        }

        function switchFile(filePath) {
            if (!projectModels[filePath]) {
                console.error(`Model not found for path: ${filePath}`);
                return;
            }
            activeFilePath = filePath;
            monacoEditor.setModel(projectModels[filePath]);
            renderFileExplorer();
        }

        // --- Preview Logic ---
        function updatePreview() {
            try {
                const frame = document.getElementById('previewFrame');
                if (!frame) return;

                let htmlContent = projectModels['index.html']?.getValue() || '';
                
                const linkRegex = /<link\s+.*?href="([^"]+)"[^>]*>/g;
                const scriptRegex = /<script\s+.*?src="([^"]+)"[^>]*><\/script>/g;

                htmlContent = htmlContent.replace(linkRegex, (match, href) => {
                    const cssContent = projectModels[href]?.getValue();
                    return cssContent ? `<style>\n${cssContent}\n</style>` : match;
                });

                htmlContent = htmlContent.replace(scriptRegex, (match, src) => {
                    const jsContent = projectModels[src]?.getValue();
                    return jsContent ? `<script>${jsContent.replace(/<\/script>/g, '<\\/script>')}<\/script>` : match;
                });

                frame.srcdoc = htmlContent;
            } catch (e) { 
                console.error("L·ªói khi c·∫≠p nh·∫≠t xem tr∆∞·ªõc:", e);
            }
        }
        
        function setPreviewMode(mode) {
            const frame = document.getElementById('previewFrame');
            if (mode === 'desktop') {
                frame.style.width = '100%';
                frame.style.height = '100%';
            } else {
                frame.style.width = '375px';
                frame.style.height = '667px';
            }
        }

        // --- AI Interaction Logic ---
        async function getAiSuggestion() {
            undoStacks = {};
            const userPrompt = document.getElementById('aiPromptInput').value.trim();
            if (!userPrompt) {
                statusEl.textContent = "Vui l√≤ng nh·∫≠p y√™u c·∫ßu cho AI.";
                return;
            }

            setLoadingState(true);
            aiResponseContainer.innerHTML = '';
            aiResponsePlaceholder.textContent = "ƒêang ch·ªù ph·∫£n h·ªìi...";
            aiResponseContainer.appendChild(aiResponsePlaceholder);

            try {
                let projectContext = '';
                let finalPrompt = '';
                const isFocusMode = focusModeCheckbox.checked;
                const selection = monacoEditor.getSelection();
                const selectedText = monacoEditor.getModel().getValueInRange(selection);

                if (isFocusMode) {
                    if (!selectedText) {
                        throw new Error("Ch·∫ø ƒë·ªô T·∫≠p trung ƒëang b·∫≠t. Vui l√≤ng b√¥i ƒëen m·ªôt ƒëo·∫°n code.");
                    }
                    projectContext = `The user has selected the following code snippet from the file \`${activeFilePath}\`:\n\`\`\`\n${selectedText}\n\`\`\``;
                    finalPrompt = `You are an expert code modification assistant. Your task is to modify the provided code snippet based on the user's request.
CODE SNIPPET:
${projectContext}
USER'S REQUEST:
"${userPrompt}"
TASK:
Generate a JSON object with a "changes" array containing a single modification object.
- The "action" must be "modify".
- The "file" must be "${activeFilePath}".
- The "oldCode" MUST be the entire original code snippet provided.
- The "newCode" MUST be the complete, modified version of the snippet.
**CRITICAL JSON FORMATTING RULES:**
- All values must be valid JSON strings (newlines escaped as \\n, quotes as \\").
Wrap the final JSON in \`\`\`json ... \`\`\`.`;

                } else {
                    Object.entries(projectModels).forEach(([path, model]) => {
                        projectContext += `--- START OF ${path} ---\n${model.getValue()}\n--- END OF ${path} ---\n\n`;
                    });
                    finalPrompt = `You are an expert code modification and creation assistant. Analyze the user's request based on the project files.
PROJECT FILES:
${projectContext}
CURRENT USER'S REQUEST:
"${userPrompt}"
TASK:
Generate a JSON object with a "changes" array. Each object in the array represents an action:
- For MODIFICATIONS: { "action": "modify", "file": "path/to/file.ext", "description": "...", "oldCode": "...", "newCode": "..." }
- For NEW FILES: { "action": "create", "file": "path/to/new_file.ext", "description": "...", "newCode": "..." }
**CRITICAL JSON FORMATTING RULES:**
- All values MUST be valid JSON strings (newlines escaped as \\n, quotes as \\").
Wrap the final JSON in \`\`\`json ... \`\`\`.`;
                }

                const result = await aiModel.generateContent(finalPrompt);
                const jsonString = result.response.text().match(/```json\s*([\s\S]*?)\s*```/)?.[1].trim();
                if (!jsonString) throw new Error("Ph·∫£n h·ªìi c·ªßa AI kh√¥ng h·ª£p l·ªá.");

                const aiResponse = JSON.parse(jsonString);
                if (!aiResponse.changes || !Array.isArray(aiResponse.changes)) throw new Error("Ph·∫£n h·ªìi JSON kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.");
                
                renderChangeList(aiResponse.changes);

            } catch (error) {
                console.error("L·ªói AI:", error);
                statusEl.textContent = `L·ªói: ${error.message}`;
            } finally {
                setLoadingState(false);
            }
        }

        function renderChangeList(changes) {
            aiResponseContainer.innerHTML = '';
            if (changes.length === 0) {
                aiResponsePlaceholder.textContent = "AI kh√¥ng t√¨m th·∫•y thay ƒë·ªïi n√†o.";
                aiResponseContainer.appendChild(aiResponsePlaceholder);
                return;
            }

            changes.forEach((change, i) => {
                change.uniqueId = `change-${i}`;
                const card = document.createElement('div');
                card.className = 'bg-white p-4 mb-4 rounded-lg shadow-md';
                card.id = change.uniqueId;
                
                if (change.action === 'create') {
                    card.innerHTML = `<p class="font-semibold text-gray-800">${change.description}</p>
                                      <p class="text-sm text-gray-500 mt-2">T·∫°o t·ªáp m·ªõi: <code class="font-mono bg-gray-200 p-1 rounded">${change.file}</code></p>
                                      <pre class="code-new mt-2"><code></code></pre>`;
                    card.querySelector('.code-new code').textContent = change.newCode;
                } else { // modify
                    card.innerHTML = `<p class="font-semibold text-gray-800">${change.description}</p>
                                      <p class="text-sm text-gray-500 mt-2">Trong t·ªáp: <code class="font-mono bg-gray-200 p-1 rounded">${change.file}</code></p>
                                      <div class="mt-2"><p class="text-sm font-medium text-gray-500">Code c≈©:</p><pre class="code-old"><code></code></pre></div>
                                      <div class="mt-2"><p class="text-sm font-medium text-gray-500">Code m·ªõi:</p><pre class="code-new"><code></code></pre></div>`;
                    card.querySelector('.code-old code').textContent = change.oldCode;
                    card.querySelector('.code-new code').textContent = change.newCode;
                }
                
                const applyButtonContainer = document.createElement('div');
                applyButtonContainer.className = 'apply-buttons mt-4';
                applyButtonContainer.innerHTML = `<button class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">√Åp d·ª•ng</button>`;
                applyButtonContainer.querySelector('button').addEventListener('click', () => applySingleChange(change));
                
                const undoButtonContainer = document.createElement('div');
                undoButtonContainer.className = 'undo-buttons mt-4 hidden';
                undoButtonContainer.innerHTML = `<button class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">[‚Ü∂] Ho√†n t√°c</button>`;
                undoButtonContainer.querySelector('button').addEventListener('click', () => undoChange(change.uniqueId));

                card.appendChild(applyButtonContainer);
                card.appendChild(undoButtonContainer);
                aiResponseContainer.appendChild(card);
            });
        }

        function applySingleChange(change) {
            const card = document.getElementById(change.uniqueId);
            if (change.action === 'create') {
                const parts = change.file.split('/');
                const filename = parts.pop();
                const parentPath = parts.join('/');
                const { item: parentFolder } = findItemByPath(parentPath);
                if (parentFolder && (parentPath === '' || parentFolder.type === 'folder')) {
                    const targetChildren = parentPath ? parentFolder.children : projectStructure;
                    targetChildren[filename] = { type: 'file' };
                    projectModels[change.file] = monaco.editor.createModel(change.newCode, getLanguageForFile(change.file));
                    projectModels[change.file].onDidChangeContent(updatePreview);
                    
                    undoStacks[change.uniqueId] = { action: 'create', path: change.file };

                    renderFileExplorer();
                    switchFile(change.file);
                    statusEl.textContent = `ƒê√£ t·∫°o t·ªáp ${change.file}`;
                } else {
                    alert(`Kh√¥ng th·ªÉ t·∫°o t·ªáp, th∆∞ m·ª•c cha "${parentPath}" kh√¥ng t·ªìn t·∫°i.`);
                    return;
                }
            } else { // modify
                const targetModel = projectModels[change.file];
                if (!targetModel) {
                    alert(`Kh√¥ng t√¨m th·∫•y t·ªáp ${change.file}`);
                    return;
                }

                const isFocusMode = focusModeCheckbox.checked;
                const selection = monacoEditor.getSelection();
                
                let matchRange;
                if (isFocusMode && !selection.isEmpty() && change.file === activeFilePath) {
                    matchRange = selection;
                } else {
                    const match = targetModel.findMatches(change.oldCode, false, false, true, null, true)[0];
                    if (match) {
                        matchRange = match.range;
                    }
                }

                if (matchRange) {
                    let inverseEdits = [];
                    targetModel.pushEditOperations([], [{ range: matchRange, text: change.newCode }], (inverse) => { inverseEdits = inverse; return null; });
                    
                    undoStacks[change.uniqueId] = { action: 'modify', path: change.file, edits: inverseEdits };

                    statusEl.textContent = `ƒê√£ c·∫≠p nh·∫≠t t·ªáp ${change.file}`;
                } else {
                    alert(`Kh√¥ng t√¨m th·∫•y m√£ c≈© trong t·ªáp ${change.file}`);
                    return;
                }
            }
            card.querySelector('.apply-buttons').classList.add('hidden');
            card.querySelector('.undo-buttons').classList.remove('hidden');
        }
        
        function undoChange(uniqueId) {
            const undoInfo = undoStacks[uniqueId];
            if (!undoInfo) return;
            
            if (undoInfo.action === 'create') {
                window.handleDelete(undoInfo.path, true); // Pass true to skip confirm
                statusEl.textContent = `ƒê√£ ho√†n t√°c (x√≥a) t·ªáp ${undoInfo.path}`;
            } else { // modify
                const targetModel = projectModels[undoInfo.path];
                if (targetModel && undoInfo.edits) {
                    targetModel.pushEditOperations([], undoInfo.edits, () => null);
                    statusEl.textContent = `ƒê√£ ho√†n t√°c thay ƒë·ªïi trong ${undoInfo.path}`;
                }
            }
            
            delete undoStacks[uniqueId];
            const card = document.getElementById(uniqueId);
            card.querySelector('.apply-buttons').classList.remove('hidden');
            card.querySelector('.undo-buttons').classList.add('hidden');
        }
        
        function setLoadingState(isLoading) {
            const buttonText = document.getElementById('buttonText');
            const buttonSpinner = document.getElementById('buttonSpinner');
            runAiBtn.disabled = isLoading;
            if (buttonSpinner) buttonSpinner.classList.toggle('hidden', !isLoading);
            if (buttonText) buttonText.textContent = isLoading ? 'ƒêang x·ª≠ l√Ω...' : 'G·ª≠i y√™u c·∫ßu AI';
        }

        async function generateInitialPrompt() {
            const ideaInput = document.getElementById('ideaInput');
            const userIdea = ideaInput.value.trim();
            if (!userIdea) {
                alert("Vui l√≤ng nh·∫≠p √Ω t∆∞·ªüng c·ªßa b·∫°n.");
                return;
            }

            const generateBtnText = document.getElementById('generateBtnText');
            const generateSpinner = document.getElementById('generateSpinner');
            generatePromptBtn.disabled = true;
            generateBtnText.textContent = 'ƒêang suy nghƒ©...';
            generateSpinner.classList.remove('hidden');

            const metaPrompt = `You are an expert Senior Frontend Developer and Prompt Engineer. Your goal is to transform a user's simple idea into a comprehensive, professional, and highly detailed 'initial prompt'. This prompt will be used by another AI to generate the actual code for a web application with HTML, CSS, and JavaScript files.

Follow these core principles:
1.  **Specificity:** Break down the request into small, actionable steps for each file.
2.  **Completeness:** Ensure all necessary HTML elements, CSS styles, and JavaScript logic are included to make the application functional from the start.
3.  **Best Practices:** Instruct the AI to use modern web standards like semantic HTML, clean CSS, and well-structured JavaScript with event listeners.
4.  **User Experience:** The generated app should be user-friendly with clear labels, buttons, and initial states.

---
HERE IS AN EXAMPLE of how to transform an idea into a great prompt.
**User Idea Example:** "A simple counter app"
**Your Generated Prompt Example:**
\`\`\`
Create a functional counter application. This requires changes across multiple files.

1.  **In \`index.html\`:**
    * Clear the body and create a main container with a class "counter-container".
    * Add an \`<h1>\` with the text "Counter App".
    * Add a \`<h2>\` with an id of "counterDisplay" and initial text "0".
    * Add a container for buttons. Inside it, add two buttons: one with id "decrementBtn" and text "-", and one with id "incrementBtn" and text "+".

2.  **In \`src/css/style.css\`:**
    * Apply styling to the body for centering content vertically and horizontally and add a pleasant background color.
    * Style the ".counter-container" with a border, padding, and box-shadow to make it look like a card.
    * Style the counter display (\`#counterDisplay\`) with a large, bold font size and some margin.
    * Style the buttons to be clean, with rounded corners, padding, and a subtle hover effect.

3.  **In \`src/js/script.js\`:**
    * Add a DOMContentLoaded event listener to ensure the script runs after the HTML is loaded.
    * Inside the listener, create a state variable \`let count = 0;\`.
    * Get references to the three DOM elements: the display, the increment button, and the decrement button.
    * Create a function \`updateDisplay()\` that sets the textContent of the display element to the current \`count\`.
    * Add a 'click' event listener to the increment button. When clicked, it should increase \`count\` by 1 and then call \`updateDisplay()\`.
    * Add a 'click' event listener to the decrement button. When clicked, it should decrease \`count\` by 1 and then call \`updateDisplay()\`.
    * Call \`updateDisplay()\` once at the start to ensure the initial value of 0 is displayed correctly.
\`\`\`
---

Now, based on these principles and the example, generate a similar high-quality initial prompt for the following user's idea. Output only the generated prompt text, without any extra explanations.

**User's Idea:** "${userIdea}"`;

            try {
                const result = await aiModel.generateContent(metaPrompt);
                const generatedPrompt = result.response.text();
                document.getElementById('generatedPromptOutput').value = generatedPrompt;
            } catch (error) {
                console.error("Error generating prompt:", error);
                document.getElementById('generatedPromptOutput').value = "ƒê√£ x·∫£y ra l·ªói khi t·∫°o k·∫ø ho·∫°ch. Vui l√≤ng th·ª≠ l·∫°i.";
            } finally {
                generatePromptBtn.disabled = false;
                generateBtnText.textContent = 'T·∫°o K·∫ø ho·∫°ch Chi ti·∫øt';
                generateSpinner.classList.add('hidden');
            }
        }

        // --- Event Listeners ---
        function attachAppEventListeners() {
            document.getElementById('logout-btn').addEventListener('click', () => {
                signOut(auth).then(() => {
                    window.location.reload();
                });
            });
            document.getElementById('save-project-btn').addEventListener('click', saveProject);
            document.getElementById('load-project-btn').addEventListener('click', loadProjects);
            document.getElementById('closeLoadModalBtn').addEventListener('click', () => document.getElementById('loadProjectModal').classList.add('hidden'));
            fileExplorer.addEventListener('contextmenu', showContextMenu);
            document.addEventListener('click', hideContextMenu);
            openModalBtn.addEventListener('click', () => {
                previewModal.classList.remove('hidden');
                updatePreview();
                setPreviewMode('desktop');
            });
            closeModalBtn.addEventListener('click', () => {
                previewModal.classList.add('hidden');
            });
            desktopViewBtn.addEventListener('click', () => setPreviewMode('desktop'));
            mobileViewBtn.addEventListener('click', () => setPreviewMode('mobile'));
            openIdeaModalBtn.addEventListener('click', () => ideaModal.classList.remove('hidden'));
            closeIdeaModalBtn.addEventListener('click', () => ideaModal.classList.add('hidden'));
            generatePromptBtn.addEventListener('click', generateInitialPrompt);
            copyAndPasteBtn.addEventListener('click', () => {
                const output = document.getElementById('generatedPromptOutput');
                const mainInput = document.getElementById('aiPromptInput');
                output.select();
                document.execCommand('copy');
                mainInput.value = output.value;
                ideaModal.classList.add('hidden');
                alert('ƒê√£ sao ch√©p & d√°n k·∫ø ho·∫°ch v√†o √¥ ƒêi·ªÅu khi·ªÉn!');
            });
            runAiBtn.addEventListener('click', getAiSuggestion);
            document.getElementById('new-project-btn').addEventListener('click', () => {
                if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën t·∫°o m·ªôt d·ª± √°n m·ªõi? M·ªçi thay ƒë·ªïi ch∆∞a l∆∞u s·∫Ω b·ªã m·∫•t.")) {
                    loadInitialProject();
                }
            });
        }
        
        // Attach auth listeners immediately on load
        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            document.getElementById('auth-error').textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                document.getElementById('auth-error').textContent = error.message;
            }
        });
        document.getElementById('register-btn').addEventListener('click', async () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            document.getElementById('auth-error').textContent = '';
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                document.getElementById('auth-error').textContent = error.message;
            }
        });

    </script>
</body>
</html>
